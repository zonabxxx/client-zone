---
import Layout from '../../../layouts/Layout.astro';
import { getCalculationByShareToken, getCalculationActivities } from '../../../lib/db';
import { format } from 'date-fns';
import { sk, de } from 'date-fns/locale';
import { translateBatch } from '../../../lib/translate';

const { id, token } = Astro.params;

if (!id || !token) {
  return Astro.redirect('/not-found');
}

// Fetch calculation by share token
const result = await getCalculationByShareToken(id, token);

if (!result) {
  return Astro.redirect('/not-found');
}

const { calculation, share, organization } = result;

// Fetch communication history
const activities = await getCalculationActivities(id);
console.log('[quote page] Activities loaded:', activities.length, 'for calculation:', id);
console.log('[quote page] Activities:', JSON.stringify(activities.map(a => ({ action: a.action, comment: a.comment?.substring(0, 50) }))));

const communicationActivities = activities.filter(a => 
  a.action === 'question_received' || 
  a.action === 'client_requested_changes' ||
  a.action === 'client_approved' ||
  a.action === 'client_rejected'
);
console.log('[quote page] Communication activities:', communicationActivities.length);

// Also check share for client comment (fallback if no activities)
const hasShareComment = share.clientComment && share.clientComment.trim().length > 0;
console.log('[quote page] Share has comment:', hasShareComment, share.clientComment?.substring(0, 50));

// üåç Language support - read from query parameter
type Language = 'sk' | 'de-AT';
const langParam = Astro.url.searchParams.get('lang') as Language | null;
const lang: Language = langParam === 'de-AT' ? 'de-AT' : 'sk';
const isGerman = lang === 'de-AT';

// Translations for multi-language support
const translations = {
  sk: {
    quoteTitle: 'Cenov√° ponuka',
    dear: 'V√°≈æen√Ω/√°',
    preparedQuote: 'pripravili sme pre V√°s ponuku',
    inPreparation: 'V pr√≠prave',
    waitingApproval: 'ƒåak√° na schv√°lenie',
    approved: 'Schv√°len√©',
    rejected: 'Zamietnut√©',
    changesRequested: 'Po≈æadovan√© zmeny',
    expired: 'Ponuka expirovala',
    contactUs: 'Kontaktujte n√°s pre aktu√°lnu ponuku.',
    details: 'Detaily',
    products: 'Produkty',
    product: 'produkt',
    productsPlural: 'produkty',
    services: 'Slu≈æby',
    service: 'slu≈æba',
    servicesPlural: 'slu≈æby',
    subtotalWithoutVat: 'Medzis√∫ƒçet bez DPH',
    vat: 'DPH',
    reverseCharge: 'Reverse Charge',
    totalWithVat: 'Celkom s DPH',
    total: 'Celkom',
    deliveryIn: 'Dodanie do',
    workingDays: 'pracovn√Ωch dn√≠',
    yourPrice: 'Va≈°a cena',
    includingVat: 'vr√°tane DPH',
    netPrice: 'netto (Reverse Charge)',
    validUntil: 'Ponuka plat√≠ do',
    approve: 'S√∫hlas√≠m s ponukou',
    question: 'M√°m ot√°zku',
    reject: 'Nem√°m z√°ujem',
    thankYouApproved: 'ƒéakujeme za schv√°lenie!',
    responseRecorded: 'Odpoveƒè zaznamenan√°',
    questionSent: 'Va≈°a ot√°zka bola odoslan√°',
    willContactApproved: 'Budeme V√°s ƒçoskoro kontaktova≈• ohƒæadom ƒèal≈°√≠ch krokov.',
    willContactRejected: 'ƒéakujeme za odpoveƒè. Ak zmen√≠te n√°zor, nev√°hajte n√°s kontaktova≈•.',
    willContactQuestion: 'Budeme V√°s ƒçoskoro kontaktova≈• s odpoveƒèou.',
    backToList: 'Sp√§≈• na zoznam pon√∫k',
    allRightsReserved: 'V≈°etky pr√°va vyhraden√©',
    pcs: 'ks',
    waitingForClient: 'ƒåak√°me na va≈°e √∫daje',
    weNeedFromYou: 'Potrebujeme od v√°s',
    pleaseProvide: 'Pros√≠m dodajte nasledovn√© √∫daje:',
    viewAllOrders: 'Zobrazi≈• v≈°etky z√°kazky',
    clientPortal: 'Klientsk√Ω port√°l',
    communicationHistory: 'Hist√≥ria komunik√°cie',
    yourQuestion: 'Va≈°a ot√°zka',
    youApproved: 'Schv√°lili ste ponuku',
    youRejected: 'Zamietli ste ponuku',
    noCommunication: 'Zatiaƒæ ≈æiadna komunik√°cia',
  },
  'de-AT': {
    quoteTitle: 'Angebot',
    dear: 'Sehr geehrte/r',
    preparedQuote: 'wir haben ein Angebot f√ºr Sie vorbereitet',
    inPreparation: 'In Vorbereitung',
    waitingApproval: 'Wartet auf Genehmigung',
    approved: 'Genehmigt',
    rejected: 'Abgelehnt',
    changesRequested: '√Ñnderungen angefordert',
    expired: 'Angebot abgelaufen',
    contactUs: 'Kontaktieren Sie uns f√ºr ein aktuelles Angebot.',
    details: 'Details',
    products: 'Produkte',
    product: 'Produkt',
    productsPlural: 'Produkte',
    services: 'Dienstleistungen',
    service: 'Dienstleistung',
    servicesPlural: 'Dienstleistungen',
    subtotalWithoutVat: 'Zwischensumme netto',
    vat: 'MwSt.',
    reverseCharge: 'Reverse Charge',
    totalWithVat: 'Gesamt inkl. MwSt.',
    total: 'Gesamt netto',
    deliveryIn: 'Lieferung in',
    workingDays: 'Werktagen',
    yourPrice: 'Ihr Preis',
    includingVat: 'inkl. MwSt.',
    netPrice: 'netto (Reverse Charge)',
    validUntil: 'Angebot g√ºltig bis',
    approve: 'Angebot annehmen',
    question: 'Frage stellen',
    reject: 'Kein Interesse',
    thankYouApproved: 'Vielen Dank f√ºr Ihre Zustimmung!',
    responseRecorded: 'Antwort aufgezeichnet',
    questionSent: 'Ihre Frage wurde gesendet',
    willContactApproved: 'Wir werden Sie in K√ºrze bez√ºglich der n√§chsten Schritte kontaktieren.',
    willContactRejected: 'Vielen Dank f√ºr Ihre Antwort. Falls Sie Ihre Meinung √§ndern, kontaktieren Sie uns gerne.',
    willContactQuestion: 'Wir werden Sie in K√ºrze mit einer Antwort kontaktieren.',
    backToList: 'Zur√ºck zur Angebotsliste',
    allRightsReserved: 'Alle Rechte vorbehalten',
    pcs: 'Stk.',
    waitingForClient: 'Wir warten auf Ihre Daten',
    weNeedFromYou: 'Wir ben√∂tigen von Ihnen',
    pleaseProvide: 'Bitte senden Sie uns folgende Informationen:',
    viewAllOrders: 'Alle Auftr√§ge anzeigen',
    clientPortal: 'Kundenportal',
    communicationHistory: 'Kommunikationsverlauf',
    yourQuestion: 'Ihre Frage',
    youApproved: 'Sie haben das Angebot angenommen',
    youRejected: 'Sie haben das Angebot abgelehnt',
    noCommunication: 'Noch keine Kommunikation',
  },
};

const t = translations[lang];

// Check if expired
const isExpired = share.expiresAt && new Date(share.expiresAt) < new Date();

// Parse calculation data
let calculationData: any = {};
try {
  calculationData = typeof calculation.calculationData === 'string' 
    ? JSON.parse(calculation.calculationData) 
    : calculation.calculationData || {};
} catch { /* ignore */ }

// Get products, services, materials
const products = calculationData.products || [];
const services = calculationData.services || [];
const materials = calculationData.materials || [];

// üåç Dynamic translation for product/service names
const translationMap = new Map<string, string>();

if (isGerman) {
  // Collect all texts that need translation
  const textsToTranslate: string[] = [];
  
  // Helper to build full product name (same logic as getProductName but without translation)
  function buildProductNameRaw(p: any): string {
    const templateName = p.productTemplate?.name || p.template?.name || '';
    const productName = p.product?.name || p.product?.categoryName || p.name || '';
    const variantName = p.variant?.name || p.variant?.variantName || '';
    
    if (templateName) {
      if (variantName && variantName !== templateName) {
        return `${templateName} - ${variantName}`;
      }
      return templateName;
    }
    
    if (productName && variantName && variantName !== productName) {
      return `${productName} - ${variantName}`;
    }
    
    return variantName || productName || '';
  }
  
  // Product full names and descriptions
  products.forEach((p: any) => {
    // Add the FULL combined product name for translation
    const fullName = buildProductNameRaw(p);
    if (fullName) textsToTranslate.push(fullName);
    
    // Also add description
    const description = p.variant?.description || p.product?.description || p.description || '';
    if (description) textsToTranslate.push(description);
  });
  
  // Service names
  services.forEach((s: any) => {
    const serviceName = s.serviceName || s.service?.name || s.name || '';
    console.log('üîß [COLLECT] Service data:', JSON.stringify(s).substring(0, 200));
    console.log('üîß [COLLECT] Service name:', serviceName);
    if (serviceName) textsToTranslate.push(serviceName);
  });
  
  // Material names
  materials.forEach((m: any) => {
    const materialName = m.materialName || m.name || '';
    if (materialName) textsToTranslate.push(materialName);
  });
  
  // Remove duplicates
  const uniqueTexts = [...new Set(textsToTranslate.filter(t => t.trim()))];
  
  console.log('üåç [TRANSLATE] Texts to translate:', uniqueTexts);
  
  if (uniqueTexts.length > 0) {
    try {
      const translated = await translateBatch(uniqueTexts, 'de-AT', 'sk');
      uniqueTexts.forEach((original, i) => {
        translationMap.set(original, translated[i]);
        console.log(`üåç [TRANSLATE] "${original}" ‚Üí "${translated[i]}"`);
      });
    } catch (e) {
      console.error('üåç [TRANSLATE] Translation failed:', e);
    }
  }
}

// Helper function to get translated text
function tr(text: string): string {
  if (!isGerman || !text) return text;
  return translationMap.get(text) || text;
}

// Helper to get full product name (including template/variant) - with translation
function getProductName(p: any): string {
  // Try to get template name first
  const templateName = p.productTemplate?.name || p.template?.name || '';
  
  // Get product category/name
  const productName = p.product?.name || p.product?.categoryName || p.name || '';
  
  // Get variant name
  const variantName = p.variant?.name || p.variant?.variantName || '';
  
  // Build full name first (without translation)
  let fullName = '';
  if (templateName) {
    if (variantName && variantName !== templateName) {
      fullName = `${templateName} - ${variantName}`;
    } else {
      fullName = templateName;
    }
  } else if (productName && variantName && variantName !== productName) {
    fullName = `${productName} - ${variantName}`;
  } else {
    fullName = variantName || productName || '';
  }
  
  // Translate the full name as one unit
  return tr(fullName) || (isGerman ? 'Produkt' : 'Produkt');
}

// Helper to get product description - with translation
function getProductDescription(p: any): string {
  const description = p.variant?.description || p.description || '';
  return tr(description);
}

// Helper to get service name - with translation
function getServiceName(s: any): string {
  const name = s.serviceName || s.service?.name || s.name || '';
  console.log('üîß [SERVICE] Raw name:', name, 'Translated:', tr(name));
  return tr(name);
}

// Helper to get material name - with translation
function getMaterialName(m: any): string {
  const name = m.materialName || m.name || '';
  return tr(name);
}

// Get client info - distinguish between contact person and company name
const selectedClient = calculationData.selectedClient || {};
const contactFirstName = selectedClient["Hlavn√Ω kontakt - meno"]?.trim() || '';
const contactLastName = selectedClient["Hlavn√Ω kontakt - priezvisko"]?.trim() || '';
const contactTitle = selectedClient["Hlavn√Ω kontakt - titul"]?.trim() || '';
const contactPerson = selectedClient.contactPerson?.trim() || '';
const companyName = selectedClient.name?.trim() || selectedClient["N√°zov"]?.trim() || calculation.companyName || '';

// Build contact person full name
const contactFullName = [contactFirstName, contactLastName].filter(Boolean).join(' ') || contactPerson;

// Determine if we have a personal contact or just company
const hasPersonalContact = !!contactFullName;

// Build display name and greeting
let clientDisplayName = '';
let clientGreeting = '';

if (hasPersonalContact) {
  // Personal contact - use name with honorific
  const isLikelyFemale = contactFirstName && contactFirstName.toLowerCase().endsWith('a') && 
    !['ondreja', 'mateja', 'luk√°≈°a', 'barnab√°≈°a'].some(ex => contactFirstName.toLowerCase().includes(ex));
  
  if (isGerman) {
    const honorific = isLikelyFemale ? 'Frau' : 'Herr';
    clientGreeting = `Sehr geehrte${isLikelyFemale ? '' : 'r'} ${honorific}`;
    clientDisplayName = contactTitle ? `${contactTitle} ${contactFullName}` : contactFullName;
  } else {
    const honorific = isLikelyFemale ? 'pani' : 'p√°n';
    clientGreeting = `V√°≈æen${isLikelyFemale ? '√°' : '√Ω'} ${honorific}`;
    clientDisplayName = contactTitle ? `${contactTitle} ${contactFullName}` : contactFullName;
  }
} else if (companyName) {
  // Company only - different greeting (no name in greeting for German)
  if (isGerman) {
    clientGreeting = 'Sehr geehrte Damen und Herren';
    clientDisplayName = ''; // Company name shown separately
  } else {
    clientGreeting = 'V√°≈æen√° spoloƒçnos≈•';
    clientDisplayName = companyName;
  }
}

// Legacy fallback
const clientName = contactFullName || companyName;

// Get VAT rate - 0% for German (reverse charge for EU B2B)
const vatRate = isGerman ? 0 : (organization?.vatRate ?? 20);

// Get global pricing multipliers (client rating + delivery term)
const globalPricing = calculationData.globalPricingBreakdown || {};
const clientMultiplier = Number(globalPricing.clientMultiplier) || 1;
const deliveryMultiplier = Number(globalPricing.deliveryMultiplier) || 1;
const combinedMultiplier = clientMultiplier * deliveryMultiplier;

// Get the final total amount (with all markups including referrer commission)
const totalAmount = Number(calculation.totalPrice) || Number(calculationData.actualTotalPrice) || 0;

// Calculate base totals without referrer markup
const computeBaseProductTotal = (p: any): number => {
  const salePrice = Number(p?.totalSale) || Number(p?.originalSalePrice) || 0;
  if (salePrice > 0) return salePrice * combinedMultiplier;
  const productPrice = Number(p?.finalPrice) || Number(p?.price) || 0;
  if (productPrice > 0) return productPrice * combinedMultiplier;
  const qty = Number(p?.quantity) || 1;
  const unitPrice = Number(p?.variant?.unitSalePrice) || Number(p?.unitPrice) || 0;
  if (unitPrice > 0) return unitPrice * qty * combinedMultiplier;
  const basePrice = Number(p?.variant?.basePrice) || 0;
  return basePrice * combinedMultiplier;
};

const baseProductTotal = products.reduce((sum: number, p: any) => sum + computeBaseProductTotal(p), 0);
// Use SALE price for services: totalSale or calculatedPrice, NOT calculatedCost
const serviceTotal = services.reduce((sum: number, s: any) => {
  const salePrice = Number(s.totalSale) || Number(s.calculatedPrice) || Number(s.salePrice) || Number(s.calculatedCost) || 0;
  return sum + salePrice * combinedMultiplier;
}, 0);
const materialTotal = materials.reduce((sum: number, m: any) => sum + (Number(m.totalSale) || Number(m.totalCost) || 0) * combinedMultiplier, 0);
const baseTotal = baseProductTotal + serviceTotal + materialTotal;

// Calculate markup ratio (includes referrer commission)
const markupRatio = (totalAmount > 0 && baseTotal > 0) ? totalAmount / baseTotal : 1;

// Final product total function - applies proportional markup
const computeProductTotal = (p: any): number => {
  const basePrice = computeBaseProductTotal(p);
  return basePrice * markupRatio; // Apply proportional markup including referrer
};

const productTotal = products.reduce((sum: number, p: any) => sum + computeProductTotal(p), 0);
const vatAmount = totalAmount * (vatRate / 100);
const totalWithVat = totalAmount + vatAmount;

// Delivery days
const deliveryDays = calculationData.overallDeliveryDays ?? null;

// Format functions - use correct locale based on language
function formatCurrency(n: number): string {
  const locale = isGerman ? 'de-AT' : 'sk-SK';
  return new Intl.NumberFormat(locale, { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
}

// Unit price formatting - preserve up to 4 decimal places for per-piece prices
function formatUnitPrice(n: number): string {
  const locale = isGerman ? 'de-AT' : 'sk-SK';
  return new Intl.NumberFormat(locale, { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 4 }).format(n || 0);
}

function formatDate(date: Date | string | null): string {
  if (!date) return '‚Äî';
  try {
    const d = new Date(date);
    const dateLocale = isGerman ? de : sk;
    return format(d, 'd. MMMM yyyy', { locale: dateLocale });
  } catch {
    return '‚Äî';
  }
}

// Client request message (when waiting for client data)
const clientRequestMessage = calculationData.clientRequestMessage || null;
const isWaitingForClient = calculation.approvalStatus === 'WAITING_FOR_CLIENT';

// Approval status config - use translations
const statusConfig: Record<string, { label: string; color: string; bgColor: string; icon: string }> = {
  'DRAFT': { label: t.inPreparation, color: 'text-slate-400', bgColor: 'bg-slate-500/20', icon: 'üìù' },
  'CLIENT_VIEWED': { label: t.waitingApproval, color: 'text-amber-400', bgColor: 'bg-amber-500/20', icon: '‚è≥' },
  'CLIENT_APPROVED': { label: t.approved, color: 'text-emerald-400', bgColor: 'bg-emerald-500/20', icon: '‚úÖ' },
  'CLIENT_REJECTED': { label: t.rejected, color: 'text-red-400', bgColor: 'bg-red-500/20', icon: '‚ùå' },
  'CLIENT_REQUESTED_CHANGES': { label: t.changesRequested, color: 'text-orange-400', bgColor: 'bg-orange-500/20', icon: '‚úèÔ∏è' },
  'WAITING_FOR_CLIENT': { label: t.waitingForClient, color: 'text-amber-400', bgColor: 'bg-amber-500/20', icon: '‚è≥' },
};

// Check for responded query param (just submitted)
const respondedAction = Astro.url.searchParams.get('responded');
const justResponded = !!respondedAction;

// Check for bundleUrl query param (came from bundle page)
const bundleUrl = Astro.url.searchParams.get('bundleUrl');

const approvalStatus = calculation.approvalStatus || 'DRAFT';
const currentStatus = statusConfig[approvalStatus] || statusConfig['DRAFT'];
const isApproved = approvalStatus === 'CLIENT_APPROVED' || respondedAction === 'approved';
const isRejected = approvalStatus === 'CLIENT_REJECTED' || respondedAction === 'rejected';
const requestedChanges = approvalStatus === 'CLIENT_REQUESTED_CHANGES' || respondedAction === 'requested_changes';
---

<Layout title={`${t.quoteTitle} - ${calculation.name}`}>
  <main class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
    <div class="max-w-2xl mx-auto px-5 py-10">
      
      {/* Back to bundle button */}
      {bundleUrl && (
        <a 
          href={bundleUrl}
          class="inline-flex items-center gap-2 text-slate-400 hover:text-white mb-6 transition-colors"
        >
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          {t.backToList}
        </a>
      )}
      
      {/* Header */}
      <div class="text-center mb-6">
        {organization && (
          <div class="text-sm text-slate-400 mb-2">{organization.name}</div>
        )}
        <h1 class="text-3xl font-bold text-white mb-2">{calculation.name}</h1>
        {(clientGreeting || clientDisplayName) && (
          <p class="text-slate-400">
            {clientGreeting}{clientDisplayName && <> <span class="font-medium text-white">{clientDisplayName}</span></>},<br />
            {t.preparedQuote}
          </p>
        )}
        
        {/* Status badge */}
        <div class="mt-4 flex justify-center">
          <span class={`inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium ${currentStatus.bgColor} ${currentStatus.color}`}>
            <span>{currentStatus.icon}</span>
            {currentStatus.label}
          </span>
        </div>
      </div>

      {/* Waiting for Client - Request Message */}
      {isWaitingForClient && clientRequestMessage && (
        <div class="glass rounded-2xl p-6 mb-6 animate-fade-in-up border-2 border-amber-500/30 bg-amber-500/5">
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 bg-amber-500/20 rounded-xl flex items-center justify-center flex-shrink-0">
              <svg class="w-6 h-6 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-amber-400 mb-1">
                {t.weNeedFromYou}
              </h3>
              <p class="text-slate-300 text-sm mb-3">
                {t.pleaseProvide}
              </p>
              <div class="bg-slate-800/50 rounded-lg p-4 text-white whitespace-pre-wrap">
                {clientRequestMessage}
              </div>
              <p class="text-xs text-slate-500 mt-3">
                {isGerman 
                  ? 'Bitte antworten Sie unten mit den angeforderten Informationen oder Dateien.'
                  : 'Pros√≠m odpovedzte ni≈æ≈°ie s po≈æadovan√Ωmi inform√°ciami alebo s√∫bormi.'}
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Expired State */}
      {isExpired && (
        <div class="glass rounded-3xl p-8 text-center mb-6 animate-fade-in-up">
          <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white mb-2">{t.expired}</h3>
          <p class="text-slate-400">{t.contactUs}</p>
        </div>
      )}

      {/* When WAITING_FOR_CLIENT - show only response form, no quote details */}
      {isWaitingForClient && !isExpired && (
        <div class="glass rounded-2xl p-6 mb-6 animate-fade-in-up">
          <form id="waitingForm" method="POST" action={`/api/quote/${id}/${token}/respond`}>
            <input type="hidden" name="action" value="requested_changes" />
            <div class="space-y-4">
              <div class="flex items-center gap-2 text-amber-400 mb-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
                </svg>
                <span class="text-sm font-medium">{isGerman ? 'Ihre Antwort' : 'Va≈°a odpoveƒè'}</span>
              </div>
              <textarea
                name="comment"
                rows="4"
                class="w-full border-2 border-amber-500/50 bg-slate-800/50 rounded-xl px-4 py-3 text-sm text-white placeholder-slate-400 focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                placeholder={isGerman ? 'Schreiben Sie Ihre Antwort oder laden Sie die angeforderten Dateien hoch...' : 'Nap√≠≈°te odpoveƒè alebo prilo≈æte po≈æadovan√© s√∫bory...'}
              ></textarea>
              <button
                type="submit"
                class="w-full py-4 rounded-xl text-lg font-bold text-slate-900 bg-gradient-to-r from-amber-400 to-amber-500 hover:from-amber-500 hover:to-amber-600 shadow-lg shadow-amber-500/20 transition-all duration-200 flex items-center justify-center gap-2"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
                {isGerman ? 'Antwort senden' : 'Odosla≈• odpoveƒè'}
              </button>
            </div>
          </form>
        </div>
      )}

      {!isExpired && !isWaitingForClient && (
        <>
          {/* Section Header - Quote Breakdown */}
          <button 
            id="toggleDetailsBtn"
            class="w-full flex items-center justify-between py-3 px-1 mb-2 hover:opacity-80 transition-all animate-fade-in-up group"
          >
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-emerald-500/20 to-blue-500/20 rounded-xl flex items-center justify-center">
                <svg class="w-5 h-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
              </div>
              <div class="text-left">
                <h3 class="text-lg font-bold text-white">{isGerman ? 'Angebotsdetails' : 'Rozpis ponuky'}</h3>
                <p class="text-xs text-slate-500">
                  {(() => {
                    const visibleServices = services.filter((s: any) => {
                      const price = Number(s.totalSale) || Number(s.calculatedPrice) || Number(s.salePrice) || Number(s.calculatedCost) || 0;
                      return price > 0;
                    });
                    return [
                      products.length > 0 && `${products.length} ${products.length === 1 ? t.product : t.productsPlural}`,
                      visibleServices.length > 0 && `${visibleServices.length} ${visibleServices.length === 1 ? t.service : t.servicesPlural}`,
                      materials.length > 0 && `${materials.length} ${isGerman ? (materials.length === 1 ? 'Material' : 'Materialien') : (materials.length === 1 ? 'materi√°l' : 'materi√°ly')}`,
                    ].filter(Boolean).join(' ¬∑ ');
                  })()}
                </p>
              </div>
            </div>
            
            <div class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-slate-800/50 group-hover:bg-slate-700/50 transition-colors">
              <span class="text-xs text-slate-400" id="toggleLabel">{isGerman ? 'Ausblenden' : 'Skry≈•'}</span>
              <svg id="chevronIcon" class="w-4 h-4 text-slate-400 transition-transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </button>

          {/* Details Panel (open by default) */}
          <div id="detailsPanel" class="mb-4 space-y-4 animate-fade-in-up stagger-1">
            {/* Materials - shown first if present */}
            {materials.length > 0 && (
              <div class="p-5 glass rounded-2xl border border-orange-500/10">
                <h4 class="font-semibold text-white mb-3 flex items-center gap-2">
                  <span class="w-6 h-6 bg-orange-500/20 rounded-md flex items-center justify-center">
                    <svg class="w-3.5 h-3.5 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                  </span>
                  {isGerman ? 'Materialien' : 'Materi√°ly'}
                </h4>
                <div class="space-y-2">
                  {materials.map((m: any, idx: number) => {
                    const materialPrice = Number(m.totalSale) || Number(m.totalCost) || (Number(m.salePrice || 0) * Number(m.quantity || 1)) || 0;
                    const quantity = Number(m.quantity) || 1;
                    const unit = m.unit || 'ks';
                    const materialTotalDisplay = materialPrice * combinedMultiplier;
                    const materialUnitPrice = quantity > 0 ? materialTotalDisplay / quantity : materialTotalDisplay;
                    return (
                      <div class="flex justify-between items-center py-2 px-3 bg-slate-800/50 rounded-lg">
                        <div class="flex flex-col">
                          <span class="text-slate-300 font-medium">
                            {getMaterialName(m) || (isGerman ? 'Material' : 'Materi√°l')}
                          </span>
                          {quantity > 1 && (
                            <span class="text-sm text-slate-400 mt-0.5">
                              {quantity} {unit} √ó {formatUnitPrice(materialUnitPrice)}
                            </span>
                          )}
                        </div>
                        <span class="font-semibold text-white">{formatCurrency(materialTotalDisplay)}</span>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
            
            {/* Products */}
            {products.length > 0 && (
              <div class="p-5 glass rounded-2xl border border-emerald-500/10">
                <h4 class="font-semibold text-white mb-3 flex items-center gap-2">
                  <span class="w-6 h-6 bg-emerald-500/20 rounded-md flex items-center justify-center">
                    <svg class="w-3.5 h-3.5 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z" />
                      <path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                  </span>
                  {t.products}
                </h4>
                <div class="space-y-2">
                  {products.map((p: any, idx: number) => {
                    // Try multiple sources for specs: templateConfigLabels, variant.templateConfigLabels, variant.description parts
                    const specs = p.templateConfigLabels 
                      || p.variant?.templateConfigLabels 
                      || p.templateConfig 
                      || p.variant?.templateConfig
                      || {};
                    const hasSpecs = Object.keys(specs).length > 0;
                    
                    // Build specs string from variant description if no templateConfigLabels
                    const variantDesc = p.variant?.description || p.variant?.variantDescription || '';
                    const descParts = variantDesc ? variantDesc.split(' ¬∑ ').filter((s: string) => s.trim()) : [];
                    const hasDescParts = !hasSpecs && descParts.length > 0;
                    
                    const description = getProductDescription(p);
                    
                    const productQty = Number(p.quantity) || 1;
                    const productTotalDisplay = computeProductTotal(p);
                    const productUnitPrice = productQty > 0 ? productTotalDisplay / productQty : productTotalDisplay;
                    
                    return (
                      <div class="py-3 px-4 bg-slate-800/50 rounded-lg">
                        <div class="flex justify-between items-start mb-2">
                          <span class="text-slate-300 font-medium">
                            {getProductName(p)}
                          </span>
                          <span class="font-bold text-white text-lg ml-4 whitespace-nowrap">{formatCurrency(productTotalDisplay)}</span>
                        </div>
                        {productQty > 1 && (
                          <div class="text-sm text-slate-400 mb-2">
                            {productQty} {t.pcs} √ó {formatUnitPrice(productUnitPrice)} = <span class="font-medium text-slate-300">{formatCurrency(productTotalDisplay)}</span>
                          </div>
                        )}
                        
                        {/* Product Specifications - show all available specs */}
                        {hasSpecs && (
                          <div class="mt-2 pt-2 border-t border-slate-700/50">
                            <div class="flex flex-wrap gap-2 text-xs">
                              {Object.entries(specs)
                                .filter(([key, value]) => value && key !== 'id' && key !== 'entityId' && key !== 'undefined')
                                .map(([key, value]) => (
                                  <span class="px-2 py-1 bg-slate-700/50 rounded text-slate-400">
                                    {value}
                                  </span>
                                ))
                              }
                            </div>
                          </div>
                        )}
                        
                        {/* Fallback to variant description parts (e.g. "1510 √ó 2240 mm ¬∑ 1 ks ¬∑ 20 mm") */}
                        {hasDescParts && (
                          <div class="mt-2 pt-2 border-t border-slate-700/50">
                            <div class="flex flex-wrap gap-2 text-xs">
                              {descParts.map((part: string) => (
                                <span class="px-2 py-1 bg-slate-700/50 rounded text-slate-400">
                                  {part}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}
                        
                        {/* Fallback to description if no specs */}
                        {!hasSpecs && !hasDescParts && description && (
                          <p class="mt-2 text-xs text-slate-500">{description}</p>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
            
            {/* Services - hide services with 0 value */}
            {services.filter((s: any) => {
              const price = Number(s.totalSale) || Number(s.calculatedPrice) || Number(s.salePrice) || Number(s.calculatedCost) || 0;
              return price > 0;
            }).length > 0 && (
              <div class="p-5 glass rounded-2xl border border-blue-500/10">
                <h4 class="font-semibold text-white mb-3 flex items-center gap-2">
                  <span class="w-6 h-6 bg-blue-500/20 rounded-md flex items-center justify-center">
                    <svg class="w-3.5 h-3.5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                  </span>
                  {t.services}
                </h4>
                <div class="space-y-2">
                  {services.filter((s: any) => {
                    const price = Number(s.totalSale) || Number(s.calculatedPrice) || Number(s.salePrice) || Number(s.calculatedCost) || 0;
                    return price > 0;
                  }).map((s: any, idx: number) => {
                    // Use SALE price: totalSale or calculatedPrice, NOT calculatedCost
                    const serviceTotalPrice = Number(s.totalSale) || Number(s.calculatedPrice) || Number(s.salePrice) || Number(s.calculatedCost) || 0;
                    
                    // Determine quantity and unit based on pricing model
                    const pricingModel = s.pricingModel || 'fixed';
                    let serviceQty = 1;
                    let serviceUnit = s.unit || 'ks';
                    let serviceUnitPrice = serviceTotalPrice;
                    
                    if (pricingModel === 'hourly') {
                      serviceQty = Number(s.inputValues?.hours) || 1;
                      serviceUnit = isGerman ? 'Std.' : 'hod';
                      serviceUnitPrice = serviceQty > 0 ? serviceTotalPrice / serviceQty : serviceTotalPrice;
                    } else if (pricingModel === 'unit') {
                      serviceQty = Number(s.inputValues?.quantity) || 1;
                      serviceUnitPrice = serviceQty > 0 ? serviceTotalPrice / serviceQty : serviceTotalPrice;
                    }
                    
                    const showBreakdown = serviceQty > 1;
                    
                    return (
                      <div class="flex justify-between items-center py-2 px-3 bg-slate-800/50 rounded-lg">
                        <div class="flex flex-col">
                          <span class="text-slate-300 font-medium">{getServiceName(s) || (isGerman ? 'Dienstleistung' : 'Slu≈æba')}</span>
                          {showBreakdown && (
                            <span class="text-sm text-slate-400 mt-0.5">
                              {serviceQty} {serviceUnit} √ó {formatUnitPrice(serviceUnitPrice)}
                            </span>
                          )}
                        </div>
                        <span class="font-semibold text-white">{formatCurrency(serviceTotalPrice)}</span>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
            
            {/* Summary */}
            <div class="p-5 glass rounded-2xl">
              <div class="space-y-2">
                <div class="flex justify-between py-1">
                  <span class="text-slate-400">{t.subtotalWithoutVat}</span>
                  <span class="text-white">{formatCurrency(totalAmount)}</span>
                </div>
                {vatRate > 0 ? (
                  <div class="flex justify-between py-1">
                    <span class="text-slate-400">{t.vat} {vatRate}%</span>
                    <span class="text-white">{formatCurrency(vatAmount)}</span>
                  </div>
                ) : (
                  <div class="flex justify-between py-1">
                    <span class="text-slate-400 text-sm">{t.reverseCharge} - {t.vat} 0%</span>
                    <span class="text-white">{formatCurrency(0)}</span>
                  </div>
                )}
                <div class="flex justify-between py-2 mt-2 border-t border-slate-700">
                  <span class="font-bold text-white text-lg">{vatRate > 0 ? t.totalWithVat : t.total}</span>
                  <span class="font-bold text-emerald-400 text-lg">{formatCurrency(totalWithVat)}</span>
                </div>
              </div>
            </div>
          </div>

          {/* Main Price Card */}
          <div class="glass rounded-3xl overflow-hidden animate-fade-in-up stagger-2">
            
            {/* Delivery info */}
            {deliveryDays !== null && (
              <div class="px-6 py-3 border-b border-slate-700/50 flex items-center justify-center gap-2 text-sm text-slate-400 bg-slate-800/30">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span>{t.deliveryIn} <strong class="text-white">{deliveryDays} {t.workingDays}</strong></span>
              </div>
            )}

            {/* Price Section */}
            <div class="p-8 bg-gradient-to-br from-emerald-500/10 to-blue-500/10">
              <div class="text-center">
                <div class="text-sm text-slate-400 mb-1">{t.yourPrice}</div>
                <div class="text-5xl font-bold text-white mb-1">
                  {formatCurrency(totalWithVat)}
                </div>
                <div class="text-sm text-slate-400">
                  {vatRate > 0 ? `${t.includingVat} ${vatRate}%` : t.netPrice}
                </div>
              </div>
            </div>

            {/* Validity */}
            {share.expiresAt && (
              <div class="px-6 py-3 bg-amber-500/10 border-t border-amber-500/30 text-center">
                <span class="text-amber-400 text-sm">
                  ‚è∞ {t.validUntil} <strong>{formatDate(share.expiresAt)}</strong>
                </span>
              </div>
            )}

            {/* Just Responded Message */}
            {justResponded && (
              <div class="p-8 text-center">
                <div class={`w-16 h-16 ${respondedAction === 'approved' ? 'bg-emerald-500/20' : respondedAction === 'rejected' ? 'bg-red-500/20' : 'bg-amber-500/20'} rounded-full flex items-center justify-center mx-auto mb-4`}>
                  {respondedAction === 'approved' && (
                    <svg class="w-8 h-8 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                  )}
                  {respondedAction === 'rejected' && (
                    <svg class="w-8 h-8 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  )}
                  {respondedAction === 'requested_changes' && (
                    <svg class="w-8 h-8 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                  )}
                </div>
                <h3 class="text-xl font-bold text-white mb-2">
                  {respondedAction === 'approved' && t.thankYouApproved}
                  {respondedAction === 'rejected' && t.responseRecorded}
                  {respondedAction === 'requested_changes' && t.questionSent}
                </h3>
                <p class="text-slate-400">
                  {respondedAction === 'approved' && t.willContactApproved}
                  {respondedAction === 'rejected' && t.willContactRejected}
                  {respondedAction === 'requested_changes' && t.willContactQuestion}
                </p>
              </div>
            )}

            {/* PDF Download Button */}
            <div class="p-4 border-t border-slate-700/50 flex justify-center">
              <a 
                href={`/api/quote/${id}/${token}/pdf?lang=${lang}`}
                class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-white font-semibold rounded-xl transition-all shadow-lg shadow-amber-600/20"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                {isGerman ? 'PDF herunterladen' : 'Stiahnu≈• PDF'}
              </a>
            </div>

            {/* Action Buttons */}
            {!isApproved && !justResponded && (
              <div class="p-6 space-y-4">
                <form id="quoteForm" method="POST" action={`/api/quote/${id}/${token}/respond`}>
                  <input type="hidden" name="action" id="actionInput" value="approved" />
                  <input type="hidden" name="comment" id="commentInput" value="" />
                  
                  <button
                    type="submit"
                    id="approveBtn"
                    class="w-full py-5 rounded-2xl text-xl font-bold text-white bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 shadow-lg shadow-emerald-500/20 hover:shadow-xl hover:shadow-emerald-500/30 transition-all duration-200 flex items-center justify-center gap-3"
                  >
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    {t.approve}
                  </button>
                </form>

                <div class="grid grid-cols-2 gap-3">
                  <button
                    id="changesBtn"
                    class="py-3 rounded-xl text-sm font-medium text-slate-300 bg-slate-700/50 hover:bg-slate-700 transition-colors"
                  >
                    {t.question}
                  </button>
                  <button
                    id="rejectBtn"
                    class="py-3 rounded-xl text-sm font-medium text-slate-400 bg-slate-800/50 hover:bg-slate-800 transition-colors"
                  >
                    {t.reject}
                  </button>
                </div>

                {/* Comment field */}
                <div id="commentSection" class="hidden space-y-3">
                  <div class="flex items-center gap-2 text-amber-400">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-sm font-medium">Va≈°a ot√°zka</span>
                  </div>
                  <textarea
                    id="commentTextarea"
                    rows="4"
                    class="w-full border-2 border-amber-500/50 bg-slate-800/50 rounded-xl px-4 py-3 text-sm text-white placeholder-slate-400 focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                    placeholder="Nap√≠≈°te n√°m va≈°u ot√°zku alebo pozn√°mku... Odpovieme v√°m ƒço najsk√¥r."
                  ></textarea>
                  <p class="text-xs text-slate-400">Po nap√≠san√≠ ot√°zky kliknite na tlaƒçidlo "Odosla≈• ot√°zku" vy≈°≈°ie.</p>
                </div>
              </div>
            )}

            {/* Approved State */}
            {isApproved && (
              <div class="p-8 text-center">
                <div class="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg class="w-8 h-8 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                  </svg>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Ponuka schv√°len√°</h3>
                <p class="text-slate-400">ƒéakujeme za d√¥veru. Va≈°a z√°kazka je v realiz√°cii.</p>
              </div>
            )}
          </div>

          {/* Communication History */}
          {(communicationActivities.length > 0 || hasShareComment) && (
            <div class="glass rounded-2xl p-6 mt-6">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center">
                  <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                  </svg>
                </div>
                <h3 class="text-lg font-semibold text-white">{t.communicationHistory}</h3>
              </div>
              <div class="space-y-3">
                {/* Show activities from calculationActivities table */}
                {communicationActivities.map((activity) => {
                  const isQuestion = activity.action === 'question_received' || activity.action === 'client_requested_changes';
                  const isApproval = activity.action === 'client_approved';
                  const isRejection = activity.action === 'client_rejected';
                  
                  return (
                    <div class={`rounded-xl p-4 ${isQuestion ? 'bg-amber-500/10 border border-amber-500/20' : isApproval ? 'bg-emerald-500/10 border border-emerald-500/20' : 'bg-red-500/10 border border-red-500/20'}`}>
                      <div class="flex items-start gap-3">
                        <div class={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${isQuestion ? 'bg-amber-500/20' : isApproval ? 'bg-emerald-500/20' : 'bg-red-500/20'}`}>
                          {isQuestion ? (
                            <svg class="w-4 h-4 text-amber-400" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
                            </svg>
                          ) : isApproval ? (
                            <svg class="w-4 h-4 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                          ) : (
                            <svg class="w-4 h-4 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                          )}
                        </div>
                        <div class="flex-1 min-w-0">
                          <div class={`text-sm font-medium ${isQuestion ? 'text-amber-300' : isApproval ? 'text-emerald-300' : 'text-red-300'}`}>
                            {isQuestion ? t.yourQuestion : isApproval ? t.youApproved : t.youRejected}
                          </div>
                          {activity.comment && (
                            <p class="text-slate-300 text-sm mt-1 whitespace-pre-wrap">"{activity.comment}"</p>
                          )}
                          <p class="text-slate-500 text-xs mt-2">
                            {format(activity.createdAt, 'd. MMM yyyy, HH:mm', { locale: isGerman ? de : sk })}
                          </p>
                        </div>
                      </div>
                    </div>
                  );
                })}
                
                {/* Fallback: Show comment from share table if no activities */}
                {communicationActivities.length === 0 && hasShareComment && (
                  <div class="rounded-xl p-4 bg-amber-500/10 border border-amber-500/20">
                    <div class="flex items-start gap-3">
                      <div class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 bg-amber-500/20">
                        <svg class="w-4 h-4 text-amber-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
                        </svg>
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-amber-300">{t.yourQuestion}</div>
                        <p class="text-slate-300 text-sm mt-1 whitespace-pre-wrap">"{share.clientComment}"</p>
                        {share.respondedAt && (
                          <p class="text-slate-500 text-xs mt-2">
                            {format(share.respondedAt, 'd. MMM yyyy, HH:mm', { locale: isGerman ? de : sk })}
                          </p>
                        )}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Client Portal Link */}
          <div class="mt-8 text-center">
            <a 
              href="/dashboard"
              class="inline-flex items-center gap-3 px-6 py-3 bg-slate-700/50 hover:bg-slate-600/50 border border-slate-600 rounded-xl text-slate-300 hover:text-white transition-all duration-300"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
              </svg>
              {t.viewAllOrders}
            </a>
            <p class="text-xs text-slate-500 mt-2">{t.clientPortal}</p>
          </div>

          {/* Company Footer */}
          {organization && (
            <div class="mt-8 text-center text-sm text-slate-500">
              <div class="font-medium text-slate-400">{organization.name}</div>
              {organization.address && <div>{organization.address}</div>}
              <div class="flex flex-wrap justify-center gap-x-4 gap-y-1 mt-1">
                {organization.ico && <span>IƒåO: {organization.ico}</span>}
                {organization.email && <span>{organization.email}</span>}
                {organization.phone && <span>{organization.phone}</span>}
              </div>
            </div>
          )}
        </>
      )}
    </div>
  </main>
</Layout>

<script>
  // Toggle details panel
  const toggleBtn = document.getElementById('toggleDetailsBtn');
  const detailsPanel = document.getElementById('detailsPanel');
  const chevronIcon = document.getElementById('chevronIcon');
  
  const toggleLabel = document.getElementById('toggleLabel');
  const isGermanPage = document.documentElement.lang === 'de' || window.location.search.includes('lang=de-AT');
  
  if (toggleBtn && detailsPanel && chevronIcon) {
    toggleBtn.addEventListener('click', () => {
      const isHidden = detailsPanel.classList.toggle('hidden');
      chevronIcon.classList.toggle('rotate-180');
      if (toggleLabel) {
        toggleLabel.textContent = isHidden 
          ? (isGermanPage ? 'Anzeigen' : 'Zobrazi≈•') 
          : (isGermanPage ? 'Ausblenden' : 'Skry≈•');
      }
    });
  }
  
  // Quote action buttons
  const quoteForm = document.getElementById('quoteForm') as HTMLFormElement;
  const actionInput = document.getElementById('actionInput') as HTMLInputElement;
  const commentInput = document.getElementById('commentInput') as HTMLInputElement;
  const commentSection = document.getElementById('commentSection');
  const commentTextarea = document.getElementById('commentTextarea') as HTMLTextAreaElement;
  const changesBtn = document.getElementById('changesBtn');
  const rejectBtn = document.getElementById('rejectBtn');
  const approveBtn = document.getElementById('approveBtn');
  
  if (changesBtn && quoteForm && actionInput && commentSection) {
    changesBtn.addEventListener('click', () => {
      commentSection.classList.remove('hidden');
      actionInput.value = 'question_received';
      if (approveBtn) {
        approveBtn.innerHTML = `
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
          </svg>
          Odosla≈• ot√°zku
        `;
        approveBtn.classList.remove('from-emerald-500', 'to-emerald-600', 'hover:from-emerald-600', 'hover:to-emerald-700', 'shadow-emerald-500/20', 'hover:shadow-emerald-500/30');
        approveBtn.classList.add('from-amber-500', 'to-amber-600', 'hover:from-amber-600', 'hover:to-amber-700', 'shadow-amber-500/20', 'hover:shadow-amber-500/30');
      }
      // Scroll to the comment section
      commentSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
      // Focus on textarea
      const textarea = document.getElementById('commentTextarea') as HTMLTextAreaElement;
      if (textarea) {
        setTimeout(() => textarea.focus(), 300);
      }
      // Hide the changes button since already activated
      changesBtn.classList.add('hidden');
    });
  }
  
  if (rejectBtn && quoteForm && actionInput) {
    rejectBtn.addEventListener('click', () => {
      actionInput.value = 'rejected';
      quoteForm.submit();
    });
  }
  
  // Sync comment textarea to hidden input before submit
  if (quoteForm && commentTextarea && commentInput) {
    quoteForm.addEventListener('submit', () => {
      commentInput.value = commentTextarea.value;
    });
  }
</script>
