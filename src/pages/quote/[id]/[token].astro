---
import Layout from '../../../layouts/Layout.astro';
import { getCalculationByShareToken } from '../../../lib/db';
import { format } from 'date-fns';
import { sk } from 'date-fns/locale';

const { id, token } = Astro.params;
const bundleUrl = Astro.url.searchParams.get('bundleUrl');

if (!id || !token) {
  return Astro.redirect('/not-found');
}

// Fetch calculation by share token
const result = await getCalculationByShareToken(id, token);

if (!result) {
  return Astro.redirect('/not-found');
}

const { calculation, share, organization } = result;

// Check if expired
const isExpired = share.expiresAt && new Date(share.expiresAt) < new Date();

// Get VAT rate
const vatRate = organization?.vatRate ?? 20;

// Calculate prices
const basePrice = calculation.totalPrice || 0;
const vatAmount = basePrice * (vatRate / 100);
const totalWithVat = basePrice + vatAmount;

// Get products from calculationData
const products = calculation.calculationData?.products || [];

function formatCurrency(n: number): string {
  return new Intl.NumberFormat('sk-SK', { style: 'currency', currency: 'EUR' }).format(n || 0);
}

function formatDate(date: Date | string | null): string {
  if (!date) return '‚Äî';
  try {
    const d = new Date(date);
    return format(d, 'd. MMMM yyyy', { locale: sk });
  } catch {
    return '‚Äî';
  }
}

// Get delivery days from first product
const deliveryDays = products[0]?.deliveryDays || 10;
---

<Layout title={`Cenov√° ponuka - ${calculation.name}`}>
  <main class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
    <div class="max-w-2xl mx-auto px-5 py-10">
      
      {/* Back to bundle button */}
      {bundleUrl && (
        <a 
          href={bundleUrl}
          class="inline-flex items-center gap-2 text-slate-400 hover:text-white mb-6 transition-colors"
        >
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Sp√§≈• na zoznam pon√∫k
        </a>
      )}
      
      {/* Header */}
      <div class="text-center mb-8">
        {organization && (
          <div class="text-sm text-slate-400 mb-2">{organization.name}</div>
        )}
        <h1 class="text-3xl font-bold text-white mb-2">{calculation.name}</h1>
        {calculation.companyName && (
          <p class="text-slate-400">
            V√°≈æen√Ω/√° <span class="text-white font-medium">{calculation.companyName}</span>,
            <br />pripravili sme pre V√°s ponuku
          </p>
        )}
        
        {/* Status badge */}
        <div class="mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-700/50 text-slate-300">
          <span class="text-lg">üìã</span>
          <span>V pr√≠prave</span>
        </div>
      </div>

      {/* Expired State */}
      {isExpired && (
        <div class="glass rounded-3xl p-8 text-center mb-6 animate-fade-in-up">
          <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white mb-2">Ponuka expirovala</h3>
          <p class="text-slate-400">Kontaktujte n√°s pre aktu√°lnu ponuku.</p>
        </div>
      )}

      {!isExpired && (
        <>
          {/* Products summary */}
          <div class="glass rounded-2xl p-5 mb-6 animate-fade-in-up">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <span class="w-10 h-10 bg-emerald-500/20 rounded-xl flex items-center justify-center">
                  <svg class="w-5 h-5 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z" />
                    <path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8z" clip-rule="evenodd" />
                  </svg>
                </span>
                <div>
                  <h3 class="font-semibold text-white">{products.length} produkt{products.length !== 1 ? 'y' : ''}</h3>
                  {products[0] && (
                    <p class="text-sm text-slate-400 line-clamp-1">
                      {products[0].variant?.name || products[0].name || 'Produkt'}
                    </p>
                  )}
                </div>
              </div>
              <div class="flex items-center gap-2">
                <span class="w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center">
                  <svg class="w-4 h-4 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                  </svg>
                </span>
                <span class="text-slate-400">1 slu≈æba</span>
                <button class="text-emerald-400 hover:text-emerald-300 flex items-center gap-1 text-sm">
                  Detaily
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
              </div>
            </div>
          </div>

          {/* Price Card */}
          <div class="glass rounded-3xl overflow-hidden animate-fade-in-up">
            {/* Delivery time */}
            <div class="px-6 py-4 border-b border-slate-700/50 flex items-center justify-center gap-2 text-slate-300">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <span>Dodanie do <strong>{deliveryDays} pracovn√Ωch dn√≠</strong></span>
            </div>
            
            {/* Main price */}
            <div class="p-8 text-center bg-gradient-to-br from-slate-800/50 to-slate-900/50">
              <div class="text-slate-400 mb-2">Va≈°a cena</div>
              <div class="text-5xl font-bold text-white mb-2">{formatCurrency(totalWithVat)}</div>
              <div class="text-slate-400">vr√°tane DPH {vatRate}%</div>
            </div>

            {/* Validity */}
            {share.expiresAt && (
              <div class="px-6 py-3 bg-amber-500/10 border-t border-amber-500/30 text-center">
                <span class="text-amber-400 text-sm">
                  üî¥ Ponuka plat√≠ do <strong>{formatDate(share.expiresAt)}</strong>
                </span>
              </div>
            )}

            {/* Action buttons */}
            <div class="p-6 space-y-3">
              <button 
                class="w-full py-4 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold rounded-2xl flex items-center justify-center gap-2 transition-colors"
                data-action="approve"
                data-calc-id={id}
                data-token={token}
              >
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                S√∫hlas√≠m s ponukou
              </button>
              
              <div class="grid grid-cols-2 gap-3">
                <button 
                  class="py-3 bg-slate-700/50 hover:bg-slate-700 text-slate-300 rounded-xl transition-colors"
                  data-action="question"
                >
                  M√°m ot√°zku
                </button>
                <button 
                  class="py-3 bg-slate-700/50 hover:bg-slate-700 text-slate-300 rounded-xl transition-colors"
                  data-action="reject"
                >
                  Nem√°m z√°ujem
                </button>
              </div>
            </div>
          </div>

          {/* Company Footer */}
          {organization && (
            <div class="mt-8 text-center text-sm text-slate-500">
              <div class="font-medium text-slate-400">{organization.name}</div>
            </div>
          )}
        </>
      )}
    </div>
  </main>
</Layout>

<style>
  .glass {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .animate-fade-in-up {
    animation: fadeInUp 0.5s ease-out forwards;
    opacity: 0;
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
