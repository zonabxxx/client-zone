---
import Layout from '../layouts/Layout.astro';
import { getSessionFromCookie } from '../lib/session';
import { getClientProjects } from '../lib/db';
import DashboardHeader from '../components/DashboardHeader.astro';
import Navigation from '../components/Navigation.astro';
import { format } from 'date-fns';
import { sk } from 'date-fns/locale';

const session = getSessionFromCookie(Astro.request.headers.get('cookie'));

if (!session) {
  return Astro.redirect('/');
}

// OPTIMIZED: Only load projects initially (with batch loading)
// Calculations are lazy loaded when user expands a project
const projectsResult = await getClientProjects(session.customerId, session.customerName, { limit: 20, offset: 0 });
const projects = projectsResult.items;
const hasMoreProjects = projectsResult.hasMore;
const totalProjects = projectsResult.total;

// Stats - only from loaded projects for speed
const stats = {
  total: totalProjects,
  approved: 0, // Will be updated after lazy load
  pending: 0,  // Will be updated after lazy load
  totalValue: projects.reduce((sum, p) => sum + (p.totalPrice || 0), 0),
};

function formatDate(date: Date | null): string {
  if (!date) return '‚Äî';
  try {
    return format(date, 'd. MMM yyyy', { locale: sk });
  } catch {
    return '‚Äî';
  }
}
---

<Layout title="Cenov√© ponuky">
  <main class="min-h-screen">
    <DashboardHeader customerName={session.customerName} />
    
    <div class="max-w-6xl mx-auto px-4 py-8">
      <Navigation active="projects" />
      
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="glass rounded-2xl p-6 animate-fade-in-up">
          <div class="text-3xl font-bold text-white mb-1">{stats.total}</div>
          <div class="text-slate-400 text-sm">Celkom</div>
        </div>
        <div class="glass rounded-2xl p-6 animate-fade-in-up stagger-1 border border-emerald-500/30 bg-emerald-500/5">
          <div class="text-3xl font-bold text-emerald-400 mb-1">{stats.approved}</div>
          <div class="text-slate-400 text-sm">Schv√°len√Ωch</div>
        </div>
        <div class="glass rounded-2xl p-6 animate-fade-in-up stagger-2">
          <div class="text-3xl font-bold text-amber-400 mb-1">{stats.pending}</div>
          <div class="text-slate-400 text-sm">ƒåak√° na schv√°lenie</div>
        </div>
        <div class="glass rounded-2xl p-6 animate-fade-in-up stagger-3">
          <div class="text-3xl font-bold text-blue-400 mb-1">
            {stats.totalValue.toLocaleString('sk-SK', { minimumFractionDigits: 0 })} ‚Ç¨
          </div>
          <div class="text-slate-400 text-sm">Celkov√° hodnota</div>
        </div>
      </div>

      {projects.length === 0 ? (
        <div class="glass rounded-3xl p-12 text-center animate-fade-in-up">
          <div class="text-6xl mb-4">üí∞</div>
          <h2 class="text-xl font-semibold text-white mb-2">Zatiaƒæ ≈æiadne cenov√© ponuky</h2>
          <p class="text-slate-400">Va≈°e cenov√© ponuky sa tu zobrazia hneƒè ako bud√∫ vytvoren√©.</p>
        </div>
      ) : (
        <div class="space-y-4" id="projectsContainer">
          {projects.map((project, index) => (
            <details 
              class="project-item group animate-fade-in-up"
              style={`animation-delay: ${index * 50}ms`}
              data-project-id={project.id}
              data-loaded="false"
            >
              <summary class="glass rounded-2xl p-6 cursor-pointer list-none transition-all hover:bg-white/5">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                  <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                      <span class="text-2xl project-icon">üí∞</span>
                      <div>
                        <div class="flex items-center gap-2">
                          <span class="font-mono text-xs text-blue-400">{project.projectNumber}</span>
                          <span class="project-badge hidden px-2 py-0.5 bg-emerald-500 text-white text-xs font-bold rounded-full">
                            SCHV√ÅLEN√â
                          </span>
                        </div>
                        <h3 class="text-lg font-semibold text-white">{project.name}</h3>
                      </div>
                    </div>
                    <div class="flex flex-wrap gap-4 text-sm text-slate-400">
                      <span class="flex items-center gap-1">
                        <span>üìã</span>
                        <span class="calcs-count">{project.calculationsCount}</span> pon√∫k
                      </span>
                      <span class="flex items-center gap-1">
                        <span>üìÖ</span>
                        {formatDate(project.updatedAt)}
                      </span>
                    </div>
                  </div>
                  
                  <div class="flex items-center gap-4">
                    {project.totalPrice > 0 && (
                      <div class="text-right">
                        <div class="text-xl font-bold text-white project-price">
                          {project.totalPrice.toLocaleString('sk-SK', { minimumFractionDigits: 2 })} ‚Ç¨
                        </div>
                        <div class="text-xs text-slate-400">Celkov√° hodnota</div>
                      </div>
                    )}
                    <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </div>
                </div>
              </summary>
              
              <div class="calcs-container mt-2 ml-4 md:ml-10 space-y-2">
                <div class="loading-placeholder text-center py-4 text-slate-400">
                  <span class="inline-block w-5 h-5 border-2 border-slate-400 border-t-transparent rounded-full animate-spin mr-2"></span>
                  Naƒç√≠tavam ponuky...
                </div>
              </div>
            </details>
          ))}
          
          {hasMoreProjects && (
            <div class="text-center mt-6">
              <button 
                id="loadMoreProjectsBtn"
                data-offset="20"
                class="px-6 py-3 bg-primary-600 hover:bg-primary-500 text-white font-medium rounded-xl transition-colors"
              >
                Naƒç√≠ta≈• viac ({totalProjects - 20} zost√°va)
              </button>
            </div>
          )}
        </div>
      )}
    </div>
  </main>
</Layout>

<style>
  .loading-spinner {
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
</style>

<script>
  // Lazy load calculations when project is expanded
  const projectItems = document.querySelectorAll('.project-item');
  
  projectItems.forEach(item => {
    item.addEventListener('toggle', async (e) => {
      const details = e.target as HTMLDetailsElement;
      if (!details.open) return;
      
      const projectId = details.dataset.projectId;
      const loaded = details.dataset.loaded === 'true';
      
      if (loaded || !projectId) return;
      
      const container = details.querySelector('.calcs-container');
      if (!container) return;
      
      try {
        const response = await fetch(`/api/calculations?projectId=${projectId}&limit=50`);
        const data = await response.json();
        
        if (data.items && data.items.length > 0) {
          container.innerHTML = '';
          
          let hasApproved = false;
          
          for (const calc of data.items) {
            const isApproved = calc.approvalStatus === 'CLIENT_APPROVED';
            if (isApproved) hasApproved = true;
            
            const hasShareLink = calc.shareToken && calc.shareExpiresAt && new Date(calc.shareExpiresAt) > new Date();
            
            const calcEl = document.createElement('div');
            calcEl.className = isApproved 
              ? 'rounded-xl p-4 transition-all bg-emerald-500/20 border border-emerald-500/40'
              : 'rounded-xl p-4 transition-all glass-light hover:bg-white/5';
            
            calcEl.innerHTML = `
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="text-lg">${isApproved ? '‚úÖ' : 'üìã'}</span>
                    <span class="font-mono text-xs text-blue-400">${calc.calculationNumber}</span>
                    ${isApproved ? '<span class="px-2 py-0.5 bg-emerald-500 text-white text-xs font-bold rounded-full">SCHV√ÅLEN√â</span>' : ''}
                    ${calc.approvalStatus === 'CLIENT_VIEWED' ? '<span class="px-2 py-0.5 bg-amber-500 text-white text-xs font-bold rounded-full">ƒåAK√Å NA V√ÅS</span>' : ''}
                  </div>
                  <h4 class="font-medium ${isApproved ? 'text-emerald-100' : 'text-white'}">${calc.name}</h4>
                  <div class="text-xs text-slate-400 mt-1">
                    Aktualizovan√©: ${new Date(calc.updatedAt).toLocaleDateString('sk-SK')}
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  ${calc.totalPrice ? `<div class="text-lg font-bold ${isApproved ? 'text-emerald-300' : 'text-white'}">${calc.totalPrice.toLocaleString('sk-SK', { minimumFractionDigits: 2 })} ‚Ç¨</div>` : ''}
                  ${hasShareLink ? `
                    <a href="https://app.adsun.sk/public/quote/${calc.id}/${calc.shareToken}" target="_blank" rel="noopener noreferrer" 
                       class="flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-xl transition-all ${isApproved ? 'bg-emerald-600 hover:bg-emerald-500 text-white' : 'bg-primary-600 hover:bg-primary-500 text-white'}">
                      <span>${isApproved ? 'Detail' : 'Zobrazi≈•'}</span>
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                      </svg>
                    </a>
                  ` : ''}
                </div>
              </div>
              ${isApproved ? `
                <div class="mt-3 pt-3 border-t border-emerald-500/30 flex items-center gap-2 text-sm text-emerald-300">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                  </svg>
                  <span>T√°to cenov√° ponuka bola schv√°len√°. Z√°kazka je v realiz√°cii.</span>
                </div>
              ` : ''}
            `;
            
            container.appendChild(calcEl);
          }
          
          // Update project styling if has approved
          if (hasApproved) {
            const summary = details.querySelector('summary');
            if (summary) {
              summary.classList.remove('hover:bg-white/5');
              summary.classList.add('border-2', 'border-emerald-500/50', 'bg-emerald-500/10', 'hover:bg-emerald-500/15');
            }
            const icon = details.querySelector('.project-icon');
            if (icon) icon.textContent = '‚úÖ';
            const badge = details.querySelector('.project-badge');
            if (badge) badge.classList.remove('hidden');
            const price = details.querySelector('.project-price');
            if (price) price.classList.add('text-emerald-400');
          }
          
          // Update count
          const countEl = details.querySelector('.calcs-count');
          if (countEl) countEl.textContent = data.items.length.toString();
          
        } else {
          container.innerHTML = '<div class="text-center py-4 text-slate-400">≈Ωiadne ponuky v tomto projekte.</div>';
        }
        
        details.dataset.loaded = 'true';
        
      } catch (error) {
        console.error('Error loading calculations:', error);
        container.innerHTML = '<div class="text-center py-4 text-red-400">Chyba pri naƒç√≠tan√≠. Sk√∫ste znova.</div>';
      }
    });
  });
  
  // Load more projects
  const loadMoreBtn = document.getElementById('loadMoreProjectsBtn') as HTMLButtonElement | null;
  const projectsContainer = document.getElementById('projectsContainer');
  
  if (loadMoreBtn && projectsContainer) {
    loadMoreBtn.addEventListener('click', async () => {
      const offset = parseInt(loadMoreBtn.dataset.offset || '20');
      
      loadMoreBtn.disabled = true;
      loadMoreBtn.innerHTML = '<span class="loading-spinner inline-block w-5 h-5 border-2 border-white border-t-transparent rounded-full"></span> Naƒç√≠tavam...';
      
      try {
        const response = await fetch(`/api/projects?offset=${offset}&limit=20`);
        const data = await response.json();
        
        if (data.items && data.items.length > 0) {
          for (const project of data.items) {
            const details = document.createElement('details');
            details.className = 'project-item group animate-fade-in-up';
            details.dataset.projectId = project.id;
            details.dataset.loaded = 'false';
            
            details.innerHTML = `
              <summary class="glass rounded-2xl p-6 cursor-pointer list-none transition-all hover:bg-white/5">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                  <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                      <span class="text-2xl project-icon">üí∞</span>
                      <div>
                        <div class="flex items-center gap-2">
                          <span class="font-mono text-xs text-blue-400">${project.projectNumber}</span>
                          <span class="project-badge hidden px-2 py-0.5 bg-emerald-500 text-white text-xs font-bold rounded-full">SCHV√ÅLEN√â</span>
                        </div>
                        <h3 class="text-lg font-semibold text-white">${project.name}</h3>
                      </div>
                    </div>
                    <div class="flex flex-wrap gap-4 text-sm text-slate-400">
                      <span class="flex items-center gap-1">
                        <span>üìã</span>
                        <span class="calcs-count">${project.calculationsCount}</span> pon√∫k
                      </span>
                      <span class="flex items-center gap-1">
                        <span>üìÖ</span>
                        ${new Date(project.updatedAt).toLocaleDateString('sk-SK')}
                      </span>
                    </div>
                  </div>
                  <div class="flex items-center gap-4">
                    ${project.totalPrice > 0 ? `
                      <div class="text-right">
                        <div class="text-xl font-bold text-white project-price">${project.totalPrice.toLocaleString('sk-SK', { minimumFractionDigits: 2 })} ‚Ç¨</div>
                        <div class="text-xs text-slate-400">Celkov√° hodnota</div>
                      </div>
                    ` : ''}
                    <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </div>
                </div>
              </summary>
              <div class="calcs-container mt-2 ml-4 md:ml-10 space-y-2">
                <div class="loading-placeholder text-center py-4 text-slate-400">
                  <span class="inline-block w-5 h-5 border-2 border-slate-400 border-t-transparent rounded-full animate-spin mr-2"></span>
                  Naƒç√≠tavam ponuky...
                </div>
              </div>
            `;
            
            // Add toggle listener
            details.addEventListener('toggle', async (e) => {
              // Same logic as above - lazy load calculations
              const det = e.target as HTMLDetailsElement;
              if (!det.open || det.dataset.loaded === 'true') return;
              
              const projId = det.dataset.projectId;
              const container = det.querySelector('.calcs-container');
              if (!container || !projId) return;
              
              try {
                const resp = await fetch(`/api/calculations?projectId=${projId}&limit=50`);
                const calcData = await resp.json();
                
                if (calcData.items?.length > 0) {
                  container.innerHTML = '';
                  let hasApproved = false;
                  
                  for (const calc of calcData.items) {
                    const isApproved = calc.approvalStatus === 'CLIENT_APPROVED';
                    if (isApproved) hasApproved = true;
                    const hasShareLink = calc.shareToken && calc.shareExpiresAt && new Date(calc.shareExpiresAt) > new Date();
                    
                    const el = document.createElement('div');
                    el.className = isApproved ? 'rounded-xl p-4 bg-emerald-500/20 border border-emerald-500/40' : 'rounded-xl p-4 glass-light';
                    el.innerHTML = `
                      <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
                        <div class="flex-1">
                          <div class="flex items-center gap-2 mb-1">
                            <span class="text-lg">${isApproved ? '‚úÖ' : 'üìã'}</span>
                            <span class="font-mono text-xs text-blue-400">${calc.calculationNumber}</span>
                            ${isApproved ? '<span class="px-2 py-0.5 bg-emerald-500 text-white text-xs font-bold rounded-full">SCHV√ÅLEN√â</span>' : ''}
                          </div>
                          <h4 class="font-medium ${isApproved ? 'text-emerald-100' : 'text-white'}">${calc.name}</h4>
                        </div>
                        <div class="flex items-center gap-3">
                          ${calc.totalPrice ? `<div class="text-lg font-bold ${isApproved ? 'text-emerald-300' : 'text-white'}">${calc.totalPrice.toLocaleString('sk-SK', {minimumFractionDigits: 2})} ‚Ç¨</div>` : ''}
                          ${hasShareLink ? `<a href="https://app.adsun.sk/public/quote/${calc.id}/${calc.shareToken}" target="_blank" class="px-4 py-2 text-sm font-medium rounded-xl ${isApproved ? 'bg-emerald-600 text-white' : 'bg-primary-600 text-white'}">${isApproved ? 'Detail' : 'Zobrazi≈•'}</a>` : ''}
                        </div>
                      </div>
                    `;
                    container.appendChild(el);
                  }
                  
                  if (hasApproved) {
                    const sum = det.querySelector('summary');
                    sum?.classList.add('border-2', 'border-emerald-500/50', 'bg-emerald-500/10');
                    const icon = det.querySelector('.project-icon');
                    if (icon) icon.textContent = '‚úÖ';
                  }
                } else {
                  container.innerHTML = '<div class="text-center py-4 text-slate-400">≈Ωiadne ponuky.</div>';
                }
                det.dataset.loaded = 'true';
              } catch (err) {
                container.innerHTML = '<div class="text-center py-4 text-red-400">Chyba.</div>';
              }
            });
            
            loadMoreBtn.parentElement?.parentElement?.insertBefore(details, loadMoreBtn.parentElement);
          }
          
          const newOffset = offset + data.items.length;
          if (data.hasMore) {
            loadMoreBtn.dataset.offset = newOffset.toString();
            loadMoreBtn.innerHTML = `Naƒç√≠ta≈• viac (${data.total - newOffset} zost√°va)`;
            loadMoreBtn.disabled = false;
          } else {
            loadMoreBtn.parentElement?.remove();
          }
        }
      } catch (error) {
        console.error('Error:', error);
        loadMoreBtn.innerHTML = 'Chyba, sk√∫ste znova';
        loadMoreBtn.disabled = false;
      }
    });
  }
</script>
