---
import Layout from '../layouts/Layout.astro';
import { getSessionFromCookie } from '../lib/session';
import { getClientStatistics } from '../lib/db';
import { format } from 'date-fns';
import { sk } from 'date-fns/locale';

const session = getSessionFromCookie(Astro.request.headers.get('cookie'));

if (!session) {
  return Astro.redirect('/');
}

const stats = await getClientStatistics(session.customerId, session.customerName);

// Calculate max for bar chart scaling
const maxMonthlySpending = Math.max(...stats.monthlySpending.map(m => m.amount), 1);

// Status labels and colors
const statusConfig: Record<string, { label: string; color: string }> = {
  'DRAFT': { label: 'Koncept', color: '#6b7280' },
  'CONFIRMED': { label: 'Potvrdené', color: '#3b82f6' },
  'IN_PROGRESS': { label: 'Prebieha', color: '#f59e0b' },
  'COMPLETED': { label: 'Dokončené', color: '#22c55e' },
  'CANCELLED': { label: 'Zrušené', color: '#ef4444' },
};

function formatCurrency(value: number): string {
  return value.toLocaleString('sk-SK', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function formatDate(date: Date | null): string {
  if (!date) return '—';
  return format(date, 'd. MMMM yyyy', { locale: sk });
}

// Calculate change percentage
function calcChange(current: number, previous: number): { value: number; isPositive: boolean } {
  if (previous === 0) return { value: current > 0 ? 100 : 0, isPositive: current > 0 };
  const change = Math.round(((current - previous) / previous) * 100);
  return { value: Math.abs(change), isPositive: change >= 0 };
}

const ordersChange = calcChange(stats.ordersThisMonth, stats.ordersLastMonth);
const spendingChange = calcChange(stats.spendingThisMonth, stats.spendingLastMonth);

// Calculate donut chart segments
let cumulativePercent = 0;
const donutSegments = stats.orderStatusBreakdown.map(item => {
  const segment = {
    ...item,
    color: statusConfig[item.status]?.color || '#6b7280',
    label: statusConfig[item.status]?.label || item.status,
    dashArray: `${item.percentage} ${100 - item.percentage}`,
    dashOffset: 100 - cumulativePercent + 25, // +25 to start from top
  };
  cumulativePercent += item.percentage;
  return segment;
});
---

<Layout title="Štatistiky" activeNav="statistics">
  <main class="min-h-screen pb-24 md:pb-8">
    <!-- Header -->
    <header class="px-6 py-8 md:px-8">
      <div class="max-w-6xl mx-auto">
        <!-- Breadcrumb -->
        <div class="flex items-center gap-2 text-sm text-[#6b7280] mb-6">
          <a href="/dashboard" class="hover:text-[#f59e0b] transition-colors flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
            Domov
          </a>
        </div>
        
        <!-- Title section -->
        <div>
          <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">
            <span class="text-gradient-orange">Moje</span> štatistiky
          </h1>
          <p class="text-[#9ca3af]">
            Prehľad vašich objednávok, nákladov a trendov
          </p>
        </div>
        
        <!-- Orange divider -->
        <hr class="divider-orange mt-6" />
      </div>
    </header>
    
    <div class="max-w-6xl mx-auto px-6 md:px-8">
      <!-- Main Stats Grid -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <!-- Total Spent -->
        <div class="adsun-card p-6 animate-fade-in-up">
          <div class="flex items-center gap-2 mb-3">
            <div class="w-10 h-10 rounded-lg bg-[#f59e0b]/10 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
              </svg>
            </div>
          </div>
          <div class="stats-number stats-number-orange mb-1">{formatCurrency(stats.totalSpent)} €</div>
          <div class="text-[#6b7280] text-sm">Celkové náklady</div>
        </div>
        
        <!-- Total Orders -->
        <div class="adsun-card p-6 animate-fade-in-up stagger-1">
          <div class="flex items-center gap-2 mb-3">
            <div class="w-10 h-10 rounded-lg bg-[#3b82f6]/10 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
              </svg>
            </div>
          </div>
          <div class="stats-number stats-number-blue mb-1">{stats.totalOrders}</div>
          <div class="text-[#6b7280] text-sm">Celkom zákaziek</div>
        </div>
        
        <!-- Average Order Value -->
        <div class="adsun-card p-6 animate-fade-in-up stagger-2">
          <div class="flex items-center gap-2 mb-3">
            <div class="w-10 h-10 rounded-lg bg-[#22c55e]/10 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                <polyline points="17 6 23 6 23 12"/>
              </svg>
            </div>
          </div>
          <div class="stats-number stats-number-green mb-1">{formatCurrency(stats.averageOrderValue)} €</div>
          <div class="text-[#6b7280] text-sm">Priemerná hodnota</div>
        </div>
        
        <!-- Last Order -->
        <div class="adsun-card p-6 animate-fade-in-up stagger-3">
          <div class="flex items-center gap-2 mb-3">
            <div class="w-10 h-10 rounded-lg bg-[#a855f7]/10 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
            </div>
          </div>
          <div class="text-xl font-bold text-white mb-1">{formatDate(stats.lastOrderDate)}</div>
          <div class="text-[#6b7280] text-sm">Posledná zákazka</div>
        </div>
      </div>

      <!-- Monthly Comparison Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
        <!-- This Month Orders -->
        <div class="adsun-card p-6 animate-fade-in-up">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-white">Tento mesiac</h3>
            <div class={`flex items-center gap-1 text-sm ${ordersChange.isPositive ? 'text-[#22c55e]' : 'text-[#ef4444]'}`}>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class={!ordersChange.isPositive ? 'rotate-180' : ''}>
                <polyline points="18 15 12 9 6 15"/>
              </svg>
              {ordersChange.value}%
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-3xl font-bold text-white">{stats.ordersThisMonth}</div>
              <div class="text-sm text-[#6b7280]">Zákaziek</div>
            </div>
            <div>
              <div class="text-3xl font-bold text-[#f59e0b]">{formatCurrency(stats.spendingThisMonth)} €</div>
              <div class="text-sm text-[#6b7280]">Náklady</div>
            </div>
          </div>
        </div>
        
        <!-- Last Month Orders -->
        <div class="adsun-card p-6 animate-fade-in-up stagger-1">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-white">Minulý mesiac</h3>
            <span class="text-sm text-[#6b7280]">Pre porovnanie</span>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-3xl font-bold text-[#6b7280]">{stats.ordersLastMonth}</div>
              <div class="text-sm text-[#6b7280]">Zákaziek</div>
            </div>
            <div>
              <div class="text-3xl font-bold text-[#6b7280]">{formatCurrency(stats.spendingLastMonth)} €</div>
              <div class="text-sm text-[#6b7280]">Náklady</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Charts Row -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Monthly Spending Bar Chart -->
        <div class="lg:col-span-2 adsun-card p-6 animate-fade-in-up">
          <h3 class="text-lg font-semibold text-white mb-6">Mesačné náklady</h3>
          
          <div class="h-48 flex items-end gap-2">
            {stats.monthlySpending.map((month, i) => {
              const height = maxMonthlySpending > 0 ? (month.amount / maxMonthlySpending) * 100 : 0;
              const isCurrentMonth = i === stats.monthlySpending.length - 1;
              return (
                <div class="flex-1 flex flex-col items-center gap-2 group">
                  <div class="relative w-full">
                    <div 
                      class={`w-full rounded-t-md transition-all duration-300 ${isCurrentMonth ? 'bg-gradient-to-t from-[#f59e0b] to-[#fbbf24]' : 'bg-[#2a2a2a] group-hover:bg-[#3a3a3a]'}`}
                      style={`height: ${Math.max(height, 2)}%;`}
                    >
                    </div>
                    <!-- Tooltip -->
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-[#1a1a1a] border border-[#333] rounded text-xs text-white opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                      {formatCurrency(month.amount)} € <br/>
                      <span class="text-[#6b7280]">{month.orderCount} zákaziek</span>
                    </div>
                  </div>
                  <span class={`text-xs ${isCurrentMonth ? 'text-[#f59e0b] font-medium' : 'text-[#6b7280]'}`}>
                    {month.month}
                  </span>
                </div>
              );
            })}
          </div>
        </div>
        
        <!-- Order Status Donut Chart -->
        <div class="adsun-card p-6 animate-fade-in-up stagger-1">
          <h3 class="text-lg font-semibold text-white mb-6">Stav zákaziek</h3>
          
          {stats.orderStatusBreakdown.length > 0 ? (
            <div class="flex flex-col items-center">
              <!-- Donut Chart -->
              <div class="relative w-40 h-40 mb-6">
                <svg viewBox="0 0 42 42" class="w-full h-full -rotate-90">
                  {donutSegments.map((segment, i) => (
                    <circle
                      cx="21"
                      cy="21"
                      r="15.91549430918954"
                      fill="transparent"
                      stroke={segment.color}
                      stroke-width="5"
                      stroke-dasharray={segment.dashArray}
                      stroke-dashoffset={segment.dashOffset}
                      class="transition-all duration-500"
                      style={`animation-delay: ${i * 100}ms`}
                    />
                  ))}
                </svg>
                <div class="absolute inset-0 flex items-center justify-center flex-col">
                  <span class="text-2xl font-bold text-white">{stats.totalOrders}</span>
                  <span class="text-xs text-[#6b7280]">celkom</span>
                </div>
              </div>
              
              <!-- Legend -->
              <div class="w-full space-y-2">
                {donutSegments.map(segment => (
                  <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-2">
                      <div class="w-3 h-3 rounded-full" style={`background: ${segment.color}`}></div>
                      <span class="text-[#9ca3af]">{segment.label}</span>
                    </div>
                    <span class="text-white font-medium">{segment.count}</span>
                  </div>
                ))}
              </div>
            </div>
          ) : (
            <div class="flex items-center justify-center h-40 text-[#6b7280]">
              Žiadne dáta
            </div>
          )}
        </div>
      </div>
      
      <!-- Delivery Times & Top Services -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Delivery Times -->
        <div class="adsun-card p-6 animate-fade-in-up">
          <h3 class="text-lg font-semibold text-white mb-2">Časy realizácie</h3>
          <p class="text-xs text-[#6b7280] mb-6">Od založenia zákazky po dokončenie</p>
          
          <div class="space-y-6">
            <!-- Average Production -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <div>
                  <span class="text-[#9ca3af]">Priemerná výroba</span>
                  <span class="text-xs text-[#6b7280] block">od začatia do dokončenia</span>
                </div>
                <span class="text-xl font-bold text-white">
                  {stats.averageProductionDays !== null ? `${stats.averageProductionDays} dní` : '—'}
                </span>
              </div>
              <div class="h-2 bg-[#1a1a1a] rounded-full overflow-hidden">
                <div 
                  class="h-full bg-gradient-to-r from-[#3b82f6] to-[#60a5fa] rounded-full transition-all duration-1000"
                  style={`width: ${stats.averageProductionDays ? Math.min((stats.averageProductionDays / 30) * 100, 100) : 0}%`}
                ></div>
              </div>
            </div>
            
            <!-- Average Delivery -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <div>
                  <span class="text-[#9ca3af]">Celkový čas</span>
                  <span class="text-xs text-[#6b7280] block">od objednania do dokončenia</span>
                </div>
                <span class="text-xl font-bold text-white">
                  {stats.averageDeliveryDays !== null ? `${stats.averageDeliveryDays} dní` : '—'}
                </span>
              </div>
              <div class="h-2 bg-[#1a1a1a] rounded-full overflow-hidden">
                <div 
                  class="h-full bg-gradient-to-r from-[#f59e0b] to-[#fbbf24] rounded-full transition-all duration-1000"
                  style={`width: ${stats.averageDeliveryDays ? Math.min((stats.averageDeliveryDays / 30) * 100, 100) : 0}%`}
                ></div>
              </div>
            </div>
            
            <!-- Fastest Delivery -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <div>
                  <span class="text-[#9ca3af]">Najrýchlejšie</span>
                  <span class="text-xs text-[#6b7280] block">rekord vašich zákaziek</span>
                </div>
                <span class="text-xl font-bold text-[#22c55e]">
                  {stats.fastestDeliveryDays !== null ? `${stats.fastestDeliveryDays} dní` : '—'}
                </span>
              </div>
              <div class="h-2 bg-[#1a1a1a] rounded-full overflow-hidden">
                <div 
                  class="h-full bg-gradient-to-r from-[#22c55e] to-[#4ade80] rounded-full transition-all duration-1000"
                  style={`width: ${stats.fastestDeliveryDays ? Math.min((stats.fastestDeliveryDays / 30) * 100, 100) : 0}%`}
                ></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Top Products by Category -->
        <div class="adsun-card p-6 animate-fade-in-up stagger-1">
          <h3 class="text-lg font-semibold text-white mb-6">Produkty podľa kategórie</h3>
          
          {stats.topProducts.length > 0 ? (
            <div class="space-y-4">
              {stats.topProducts.map((product, i) => {
                const maxSpent = stats.topProducts[0]?.totalSpent || 1;
                const width = (product.totalSpent / maxSpent) * 100;
                const colors = ['from-[#f59e0b] to-[#fbbf24]', 'from-[#3b82f6] to-[#60a5fa]', 'from-[#22c55e] to-[#4ade80]', 'from-[#a855f7] to-[#c084fc]', 'from-[#ec4899] to-[#f472b6]'];
                return (
                  <div>
                    <div class="flex items-center justify-between mb-1">
                      <span class="text-sm text-white truncate flex-1 mr-2">{product.name}</span>
                      <div class="flex items-center gap-2 flex-shrink-0">
                        <span class="text-xs text-[#6b7280]">{product.count}×</span>
                        <span class="text-sm font-medium text-[#f59e0b]">{formatCurrency(product.totalSpent)} €</span>
                      </div>
                    </div>
                    <div class="h-2 bg-[#1a1a1a] rounded-full overflow-hidden">
                      <div 
                        class={`h-full bg-gradient-to-r ${colors[i % colors.length]} rounded-full transition-all duration-1000`}
                        style={`width: ${width}%`}
                      ></div>
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <div class="flex items-center justify-center h-40 text-[#6b7280]">
              Žiadne dáta o kategóriách
            </div>
          )}
        </div>
      </div>
      
      <!-- Empty State if no data -->
      {stats.totalOrders === 0 && (
        <div class="adsun-card p-12 text-center animate-fade-in-up">
          <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-[#1a1a1a] flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 3v18h18"/>
              <path d="m19 9-5 5-4-4-3 3"/>
            </svg>
          </div>
          <h2 class="text-xl font-semibold text-white mb-2">Zatiaľ žiadne štatistiky</h2>
          <p class="text-[#6b7280] mb-6">Štatistiky sa zobrazia po vašich prvých zákazkách.</p>
          <a href="/dashboard" class="btn-adsun-primary inline-flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
            Späť na dashboard
          </a>
        </div>
      )}
    </div>
  </main>
</Layout>

<style>
  /* Animate bars on load */
  @keyframes growBar {
    from { transform: scaleY(0); }
    to { transform: scaleY(1); }
  }
  
  .bar-animate {
    animation: growBar 0.6s ease-out forwards;
    transform-origin: bottom;
  }
</style>
