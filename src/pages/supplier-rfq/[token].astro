---
import Layout from '../../layouts/Layout.astro';
import { getSupplierRfqByToken } from '../../lib/db';

const { token } = Astro.params;

if (!token) {
  return Astro.redirect('/not-found');
}

// Fetch RFQ by token
const result = await getSupplierRfqByToken(token);

if (!result) {
  return Astro.redirect('/not-found');
}

const { rfq, organization } = result;

// Check if expired
const isExpired = rfq.expiresAt && new Date(rfq.expiresAt) < new Date();

// Check if already submitted
const isSubmitted = Astro.url.searchParams.get('submitted') === '1';

// Check for error
const errorParam = Astro.url.searchParams.get('error');

// Get VAT rate from RFQ
const defaultVatRate = rfq.vatRate ?? 20;

// Parse items
const items = Array.isArray(rfq.items) ? rfq.items : [];

// Parse spec string into structured key:value pairs for display
function parseSpecString(spec: string): Array<{ label: string; value: string }> {
  if (!spec) return [];
  return spec.split(' ¬∑ ').map(part => {
    const colonIdx = part.indexOf(':');
    if (colonIdx > 0) {
      return { label: part.substring(0, colonIdx).trim(), value: part.substring(colonIdx + 1).trim() };
    }
    return { label: part.trim(), value: '' };
  }).filter(s => s.label && s.label !== 'undefined');
}

// Build specs for each item: prefer specs array, fallback to parsed spec string
// Also deduplicate name (e.g. "Product ‚Äî Product" ‚Üí "Product")
const itemsWithSpecs = items.map((item: any) => {
  const specs = Array.isArray(item.specs) && item.specs.length > 0
    ? item.specs
    : item.spec ? parseSpecString(item.spec) : [];
  let name = item.name || '';
  if (name.includes(' ‚Äî ')) {
    const [left, right] = name.split(' ‚Äî ');
    if (left.trim() === right.trim()) name = left.trim();
  }
  return { ...item, name, parsedSpecs: specs };
});

// Format currency
function formatCurrency(n: number): string {
  return new Intl.NumberFormat('sk-SK', { style: 'currency', currency: 'EUR' }).format(n || 0);
}
---

<Layout title="Dopyt na nacenenie">
  <main class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
    <div class="max-w-3xl mx-auto px-5 py-10">
      
      {/* Header */}
      <div class="text-center mb-8">
        {organization && (
          <div class="text-sm text-slate-400 mb-2">{organization.name}</div>
        )}
        <h1 class="text-3xl font-bold text-white mb-2">Dopyt na nacenenie</h1>
        {!isSubmitted && !isExpired && (
          <p class="text-slate-400">
            Pros√≠m, vypl≈àte ceny a term√≠n dodania pre polo≈æky ni≈æ≈°ie.
          </p>
        )}
      </div>

      {/* Expired State */}
      {isExpired && (
        <div class="glass rounded-3xl p-8 text-center mb-6 animate-fade-in-up">
          <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white mb-2">Dopyt expiroval</h3>
          <p class="text-slate-400">Tento dopyt u≈æ nie je platn√Ω. Kontaktujte zad√°vateƒæa pre aktu√°lny dopyt.</p>
        </div>
      )}

      {/* Error State */}
      {errorParam && !isSubmitted && (
        <div class="glass rounded-3xl p-8 text-center mb-6 animate-fade-in-up border border-red-500/30">
          <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white mb-2">Chyba pri odosielan√≠</h3>
          <p class="text-slate-400 mb-4">
            {errorParam === 'RFQ not found' ? 'Dopyt nebol n√°jden√Ω.' : 
             errorParam === 'Link expired' ? 'Platnos≈• odkazu vypr≈°ala.' :
             errorParam === 'Organization not found' ? 'Organiz√°cia nebola n√°jden√°.' :
             `Nastala chyba: ${errorParam}`}
          </p>
          <p class="text-sm text-slate-500">Sk√∫ste to znova alebo kontaktujte zad√°vateƒæa.</p>
        </div>
      )}

      {/* Success State */}
      {isSubmitted && (
        <div class="glass rounded-3xl p-8 text-center mb-6 animate-fade-in-up">
          <div class="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white mb-2">ƒéakujeme!</h3>
          <p class="text-slate-400">Va≈°a ponuka bola √∫spe≈°ne odoslan√°. Budeme v√°s kontaktova≈•.</p>
        </div>
      )}

      {/* RFQ Form */}
      {!isExpired && !isSubmitted && (
        <form 
          id="rfqForm"
          class="space-y-6"
          action={`/api/supplier-rfq/${token}/respond`}
          method="POST"
        >
          {/* Items */}
          <div class="space-y-4">
            {itemsWithSpecs.map((item: any, idx: number) => (
              <div class="glass rounded-2xl p-6 animate-fade-in-up" style={`animation-delay: ${idx * 0.1}s`}>
                <div class="flex justify-between items-start mb-4">
                  <div class="flex-1">
                    <h3 class="font-semibold text-white text-lg">{item.name || `Polo≈æka ${idx + 1}`}</h3>
                    
                    {/* Structured specs as two-column table */}
                    {item.parsedSpecs.length > 0 ? (
                      <table class="mt-3 text-sm w-full" style="border-collapse: collapse;">
                        <tbody>
                          {(() => {
                            const specs = item.parsedSpecs as Array<{label: string; value: string}>;
                            const rows: Array<Array<{label: string; value: string}>> = [];
                            for (let i = 0; i < specs.length; i += 2) {
                              rows.push(specs.slice(i, i + 2));
                            }
                            return rows;
                          })().map((row: Array<{label: string; value: string}>) => (
                            <tr>
                              <td class="text-slate-500 py-1 pr-2 whitespace-nowrap align-top" style="width: 1%; white-space: nowrap;">{row[0].label}:</td>
                              <td class="text-slate-300 font-medium py-1 pr-6 align-top" style="word-break: break-word;">{row[0].value}</td>
                              {row[1] ? (
                                <>
                                  <td class="text-slate-500 py-1 pr-2 whitespace-nowrap align-top" style="width: 1%; white-space: nowrap;">{row[1].label}:</td>
                                  <td class="text-slate-300 font-medium py-1 align-top" style="word-break: break-word;">{row[1].value}</td>
                                </>
                              ) : (
                                <>
                                  <td></td>
                                  <td></td>
                                </>
                              )}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    ) : null}
                    
                    <div class="text-slate-400 text-sm mt-3">
                      Po≈æadovan√© mno≈æstvo: <strong class="text-white">{item.qty || 1} ks</strong>
                    </div>
                  </div>
                  <div id={`total-display-${idx}`} class="text-right hidden">
                    <div class="text-xs text-slate-500">Celkov√° cena</div>
                    <div class="font-semibold text-lg text-emerald-400">
                      <span id={`total-value-${idx}`}>0.00</span> ‚Ç¨
                    </div>
                  </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  {/* Unit Price */}
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">Jedn. cena (‚Ç¨)</label>
                    <input
                      type="number"
                      name={`items[${idx}][unitPrice]`}
                      step="0.0001"
                      required
                      data-idx={idx}
                      data-qty={item.qty || 1}
                      class="unit-price-input w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                      placeholder="Cena za 1 ks"
                    />
                    <div class="text-xs text-slate-500 mt-1">za 1 kus</div>
                  </div>

                  {/* Total Price */}
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">Celkom (‚Ç¨)</label>
                    <input
                      type="number"
                      step="0.01"
                      data-idx={idx}
                      data-qty={item.qty || 1}
                      class="total-price-input w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="Celkov√° cena"
                    />
                    <div class="text-xs text-slate-500 mt-1">za {item.qty || 1} ks</div>
                  </div>

                  {/* VAT */}
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">DPH (%)</label>
                    <input
                      type="number"
                      name={`items[${idx}][vatRate]`}
                      step="1"
                      value={defaultVatRate}
                      class="w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 text-white"
                    />
                  </div>

                  {/* Lead Time */}
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">Dodanie (dni)</label>
                    <input
                      type="number"
                      name={`items[${idx}][leadTimeDays]`}
                      step="1"
                      placeholder="napr. 7"
                      class="w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500"
                    />
                  </div>
                </div>

                {/* Tip */}
                <div class="mt-4 text-xs text-slate-500 bg-slate-800/30 rounded-lg p-3">
                  üí° Tip: Zadajte cenu za 1 ks alebo celkov√∫ cenu - druh√© pole sa automaticky prepoƒç√≠ta.
                </div>

                {/* Hidden fields */}
                <input type="hidden" name={`items[${idx}][itemId]`} value={item.itemId || item.id || ''} />
                <input type="hidden" name={`items[${idx}][qty]`} value={item.qty || 1} />
              </div>
            ))}
          </div>

          {/* Supplier Info */}
          <div class="glass rounded-2xl p-6 animate-fade-in-up">
            <h3 class="font-semibold text-white mb-4">Va≈°e kontaktn√© √∫daje</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-slate-400 mb-1">Va≈°e meno / firma</label>
                <input
                  type="text"
                  name="supplierName"
                  class="w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500"
                  placeholder="N√°zov firmy alebo meno"
                />
              </div>
              <div>
                <label class="block text-sm text-slate-400 mb-1">V√°≈° e-mail</label>
                <input
                  type="email"
                  name="supplierEmail"
                  class="w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500"
                  placeholder="vas@email.sk"
                />
              </div>
            </div>

            <div class="mt-4">
              <label class="block text-sm text-slate-400 mb-1">Pozn√°mka (voliteƒæn√©)</label>
              <textarea
                name="notes"
                rows="3"
                class="w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500"
                placeholder="Ak√©koƒævek dodatoƒçn√© inform√°cie k ponuke..."
              ></textarea>
            </div>
          </div>

          {/* Submit Button */}
          <button
            type="submit"
            class="w-full py-5 rounded-2xl text-xl font-bold text-white bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 shadow-lg shadow-emerald-500/20 hover:shadow-xl hover:shadow-emerald-500/30 transition-all duration-200 flex items-center justify-center gap-3"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
            Odosla≈• ponuku
          </button>
        </form>
      )}

      {/* Company Footer */}
      {organization && (
        <div class="mt-12 text-center text-sm text-slate-500">
          <div class="font-medium text-slate-400">{organization.name}</div>
          {organization.address && <div>{organization.address}</div>}
          <div class="flex flex-wrap justify-center gap-x-4 gap-y-1 mt-1">
            {organization.ico && <span>IƒåO: {organization.ico}</span>}
            {organization.email && <span>{organization.email}</span>}
            {organization.phone && <span>{organization.phone}</span>}
          </div>
        </div>
      )}
    </div>
  </main>
</Layout>

<script>
  // Price calculation - sync unit price and total price
  document.querySelectorAll('.unit-price-input').forEach((input) => {
    input.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      const idx = target.dataset.idx;
      const qty = parseFloat(target.dataset.qty || '1');
      const unitPrice = parseFloat(target.value.replace(',', '.')) || 0;
      
      if (unitPrice >= 0 && qty > 0) {
        const total = unitPrice * qty;
        const totalInput = document.querySelector(`.total-price-input[data-idx="${idx}"]`) as HTMLInputElement;
        if (totalInput) {
          totalInput.value = total.toFixed(2);
        }
        
        // Update display
        const displayEl = document.getElementById(`total-display-${idx}`);
        const valueEl = document.getElementById(`total-value-${idx}`);
        if (displayEl && valueEl && total > 0) {
          displayEl.classList.remove('hidden');
          valueEl.textContent = total.toFixed(2);
        }
      }
    });
  });

  document.querySelectorAll('.total-price-input').forEach((input) => {
    input.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      const idx = target.dataset.idx;
      const qty = parseFloat(target.dataset.qty || '1');
      const totalPrice = parseFloat(target.value.replace(',', '.')) || 0;
      
      if (totalPrice >= 0 && qty > 0) {
        const unitPrice = totalPrice / qty;
        const unitInput = document.querySelector(`.unit-price-input[data-idx="${idx}"]`) as HTMLInputElement;
        if (unitInput) {
          unitInput.value = unitPrice.toFixed(4);
        }
        
        // Update display
        const displayEl = document.getElementById(`total-display-${idx}`);
        const valueEl = document.getElementById(`total-value-${idx}`);
        if (displayEl && valueEl && totalPrice > 0) {
          displayEl.classList.remove('hidden');
          valueEl.textContent = totalPrice.toFixed(2);
        }
      }
    });
  });
</script>
