---
import Layout from '../../layouts/Layout.astro';
import { getSupplierRfqByToken } from '../../lib/db';

const { token } = Astro.params;

if (!token) {
  return Astro.redirect('/not-found');
}

// Fetch RFQ by token
const result = await getSupplierRfqByToken(token);

if (!result) {
  return Astro.redirect('/not-found');
}

const { rfq, organization } = result;

// Check if expired
const isExpired = rfq.expiresAt && new Date(rfq.expiresAt) < new Date();

// Check if already submitted
const isSubmitted = Astro.url.searchParams.get('submitted') === '1';

// Check for error
const errorParam = Astro.url.searchParams.get('error');

// Get VAT rate from RFQ
const defaultVatRate = rfq.vatRate ?? 20;

// Parse items
const items = Array.isArray(rfq.items) ? rfq.items : [];

// Parse spec string into structured key:value pairs for display
function parseSpecString(spec: string): any[] {
  if (!spec) return [];
  return spec.split(' ¬∑ ').map(part => {
    const colonIdx = part.indexOf(':');
    if (colonIdx > 0) {
      return { label: part.substring(0, colonIdx).trim(), value: part.substring(colonIdx + 1).trim() };
    }
    return { label: part.trim(), value: '' };
  }).filter(s => s.label && s.label !== 'undefined');
}

// ‚îÄ‚îÄ Icon mapping for spec labels (returns SVG path) ‚îÄ‚îÄ
function getSpecIcon(label: string): string {
  const l = label.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  // V√§zba / Binding
  if (l.includes('vazba') || l.includes('binding')) return 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253';
  // Form√°t / Rozmery / ≈†√≠rka / V√Ω≈°ka
  if (l.includes('format') || l.includes('rozmer') || l === 'width_mm' || l === 'height_mm' || l.includes('sirka') || l.includes('vyska')) return 'M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6z';
  // Mno≈æstvo / Quantity / Poƒçet
  if (l.includes('mnozstvo') || l.includes('quantity') || l.includes('pocet') || l.includes('count') || l.includes('pack') || l.includes('sheet') || l.includes('positions')) return 'M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z';
  // F√≥lia / Lamin√°cia
  if (l.includes('folia') || l.includes('foil') || l.includes('laminac') || l.includes('lamination')) return 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z';
  // Farba / Color / RAL
  if (l.includes('farba') || l.includes('color') || l.includes('ral')) return 'M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01';
  // Papier / Paper
  if (l.includes('papier') || l.includes('paper') || l.includes('paper_type')) return 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z';
  // Gram√°≈æ / Grammage
  if (l.includes('gramaz') || l.includes('grammage') || l.includes('hmotnost')) return 'M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3';
  // Tlaƒç / Print / Print method
  if (l.includes('potlac') || l.includes('tlac') || l.includes('print') || l.includes('farebnost')) return 'M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z';
  // Karton / Cardboard
  if (l.includes('karton') || l.includes('cardboard')) return 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4';
  // Spir√°la
  if (l.includes('spiral')) return 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15';
  // Ob√°lka / Cover
  if (l.includes('obalka') || l.includes('obal') || l.includes('cover')) return 'M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z';
  // Materi√°l / Material
  if (l.includes('material') || l.includes('povrch') || l.includes('surface')) return 'M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10';
  // Hr√∫bka / Thickness / Spine
  if (l.includes('hrubka') || l.includes('thickness') || l.includes('spine') || l.includes('chrbt')) return 'M4 6h16M4 12h16M4 18h7';
  // Tvar / Shape / Rez / Cut / Die-cut
  if (l.includes('tvar') || l.includes('shape') || l.includes('rez') || l.includes('cut') || l.includes('precut') || l.includes('die_cut') || l.includes('vysek')) return 'M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z';
  // Lak / Varnish
  if (l.includes('lak') || l.includes('varnish') || l.includes('uv')) return 'M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z';
  // Biela tlaƒç / White print
  if (l.includes('biela') || l.includes('white')) return 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z';
  // Razba / Embossing / Metalick√° tlaƒç
  if (l.includes('razba') || l.includes('emboss') || l.includes('metalic') || l.includes('metallic')) return 'M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z';
  // Zaoblen√© rohy / Rounded corners
  if (l.includes('oble') || l.includes('rounded') || l.includes('zaoblen')) return 'M4 16v2a2 2 0 002 2h2m0-16H6a2 2 0 00-2 2v2m16-2v-2a2 2 0 00-2-2h-2m0 16h2a2 2 0 002-2v-2';
  // Lom / Fold / Perfor√°cia
  if (l.includes('lom') || l.includes('fold') || l.includes('perfor') || l.includes('zlom')) return 'M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2';
  // Vreck√° / Pockets / Keder
  if (l.includes('vrecka') || l.includes('pockets') || l.includes('keder') || l.includes('kapsa')) return 'M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4';
  // Strany / Sides
  if (l.includes('strany') || l.includes('sides')) return 'M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2';
  // R√°m / Frame
  if (l.includes('ram') || l.includes('frame')) return 'M4 5a1 1 0 011-1h14a1 1 0 011 1v14a1 1 0 01-1 1H5a1 1 0 01-1-1V5zm3 3h10v10H7V8z';
  // Technol√≥gia / Technology
  if (l.includes('technolog')) return 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z';
  // Mont√°≈æ / Placement / Umiestnenie
  if (l.includes('montaz') || l.includes('mounting') || l.includes('placement') || l.includes('umiestnen')) return 'M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z';
  // Pohlavie / Gender / Veƒækos≈•
  if (l.includes('pohlav') || l.includes('gender') || l.includes('velkost') || l.includes('size') || l.includes('clothing')) return 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z';
  // Znaƒçka / Brand / Model
  if (l.includes('znacka') || l.includes('brand') || l.includes('model')) return 'M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z';
  // Artwork / Grafika
  if (l.includes('artwork') || l.includes('grafik') || l.includes('dizajn')) return 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z';
  // Lepidlo / Adhesive / Bleed
  if (l.includes('lepidl') || l.includes('adhesive') || l.includes('bleed') || l.includes('presah')) return 'M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1';
  // Bezpeƒçnos≈• / Security
  if (l.includes('bezpec') || l.includes('security') || l.includes('zabezpec')) return 'M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z';
  // ≈†n√∫rka / Lanyard
  if (l.includes('snurka') || l.includes('lanyard') || l.includes('pasnk')) return 'M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z';
  // Dodanie / Delivery
  if (l.includes('dodan') || l.includes('delivery') || l.includes('doprav')) return 'M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0';
  // Pozn√°mka / Note
  if (l.includes('poznamka') || l.includes('note') || l.includes('pozn')) return 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z';
  // Produkt / Product / Typ / Version
  if (l.includes('produkt') || l.includes('product') || l.includes('typ') || l.includes('version') || l.includes('verzia')) return 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4';
  // V√Ω≈°ka p√≠smen / Letter height / Text
  if (l.includes('pismen') || l.includes('letter') || l.includes('text_label')) return 'M4 6h16M12 6v12m-4 0h8';
  // ≈†√≠rka rolky / Roll width
  if (l.includes('rolka') || l.includes('roll_width')) return 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15';
  // Kazeta / Cassette
  if (l.includes('kazeta') || l.includes('cassette')) return 'M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4';
  // Dokonƒçenie / Finishing
  if (l.includes('dokoncen') || l.includes('finishing') || l.includes('uprava')) return 'M5 13l4 4L19 7';
  // default: info icon
  return 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z';
}

// ‚îÄ‚îÄ Unit mapping for spec values ‚îÄ‚îÄ
function getSpecUnit(label: string, value: string): string {
  const l = label.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  // Gram√°≈æ
  if (l.includes('gramaz') || l.includes('grammage')) return 'g/m¬≤';
  // Mno≈æstvo / Quantity / Pack / Poƒçet kusov
  if (l.includes('mnozstvo') || l.includes('quantity') || l.includes('pack_count') || l.includes('cards_per_pack')) return 'ks';
  // Poƒçet str√°n / Inner page count / Sheet count
  if (l.includes('stran') || l.includes('page_count') || l.includes('sheet_count')) return 'str.';
  // ≈†√≠rka / V√Ω≈°ka (mm)
  if (l.includes('width_mm') || l.includes('height_mm') || l.includes('sirka') || l.includes('vyska')) return 'mm';
  // Hr√∫bka / Thickness / Spine (mm)
  if (l.includes('hrubka') || l.includes('thickness') || l.includes('spine') || l.includes('chrbt')) return 'mm';
  // V√Ω≈°ka p√≠smen / Letter height
  if (l.includes('letter_height') || l.includes('pismen')) return 'mm';
  // ≈†√≠rka rolky / Roll width
  if (l.includes('roll_width') || l.includes('rolka')) return 'mm';
  // Positions / Poz√≠cie
  if (l.includes('positions') || l.includes('pozici')) return 'ks';
  // Farby / Color count
  if (l.includes('color_count') || l.includes('pocet_farieb')) return 'farieb';
  // Dodanie / Lead time
  if (l.includes('dodan') || l.includes('delivery') || l.includes('lead_time')) return 'dn√≠';
  // Bleed / Presah
  if (l.includes('bleed') || l.includes('presah')) return 'mm';
  return '';
}

// ‚îÄ‚îÄ Detect product type for SVG illustration ‚îÄ‚îÄ
function detectProductType(name: string, specs: any[]): string {
  const n = name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  const allText = n + ' ' + specs.map((s: any) => `${s.label} ${s.value}`).join(' ').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  // Viazan√© produkty: Bro≈æ√∫ry, Katal√≥gy, Knihy, Manu√°ly, ƒåasopisy, Prezent√°cie, V√Ωroƒçn√© spr√°vy, Jed√°lne l√≠stky
  if (allText.includes('manual') || allText.includes('brozur') || allText.includes('katalog') || allText.includes('kniha') || allText.includes('book') || allText.includes('revista') || allText.includes('casopis') || allText.includes('prezentac') || allText.includes('vyrocna sprava') || allText.includes('jedalne listky') || allText.includes('knizn') || allText.includes('viazane')) return 'book';
  // Billboard / Outdoor reklama
  if (allText.includes('billboard') || allText.includes('bilboard') || allText.includes('bigboard') || allText.includes('smartboard') || allText.includes('outdoor')) return 'billboard';
  // Banner / Plachta / Mesh
  if (allText.includes('banner') || allText.includes('mesh') || allText.includes('plachta') || allText.includes('pvc banner')) return 'banner';
  // Dosky / Plate Materials / PVC dosky
  if (allText.includes('dosk') || allText.includes('plate') || allText.includes('komatex') || allText.includes('stadur') || allText.includes('acrylat') || allText.includes('alumin') || allText.includes('cellular') || allText.includes('cop-plate') || allText.includes('corrugat') || allText.includes('mirror') || allText.includes('smooth-card')) return 'plate';
  // Samolepky / Etikety / N√°lepky
  if (allText.includes('samolepk') || allText.includes('sticker') || allText.includes('nalepk') || allText.includes('etiket') || allText.includes('transparentn')) return 'sticker';
  // Kalend√°re
  if (allText.includes('kalendar') || allText.includes('calendar') || allText.includes('planovaci')) return 'calendar';
  // Svadobn√° tlaƒç
  if (allText.includes('svadobn') || allText.includes('wedding') || allText.includes('svadob') || allText.includes('zasadaci poriadok') || allText.includes('menovka na svadbu') || allText.includes('menovky na svadbu') || allText.includes('oznameni') || allText.includes('pauzak')) return 'wedding';
  // Textil / Vlajka / Sublimaƒçn√° text√≠lia
  if (allText.includes('textil') || allText.includes('triko') || allText.includes('tshirt') || allText.includes('oblec') || allText.includes('vlajk') || allText.includes('sublimac') || allText.includes('potlac textilu') || allText.includes('polyester')) return 'textile';
  // Roll-up / Prezentaƒçn√© syst√©my / √Åƒçkov√Ω stojan
  if (allText.includes('roll-up') || allText.includes('rollup') || allText.includes('roll up') || allText.includes('ackovy stojan') || allText.includes('a-stojan')) return 'rollup';
  // 3D produkty / Styrodurov√© p√≠smen√°
  if (allText.includes('3d') || allText.includes('styrodur') || allText.includes('pismen')) return '3d';
  // Bloky / Zakladaƒçe / Vzorkovn√≠ky / Trhacie bloky
  if (allText.includes('zakladac') || allText.includes('vzorkovnik') || allText.includes('trhaci') || allText.includes('blok')) return 'folder';
  // Hracie kartiƒçky / Magnetky
  if (allText.includes('hraci') || allText.includes('kartic') || allText.includes('magnetk')) return 'gamecard';
  // Polep / Vehicle wrap
  if (allText.includes('polep') || allText.includes('wrap') || allText.includes('car wrap') || allText.includes('carwrap') || allText.includes('car-magnet') || allText.includes('ferrofoil')) return 'vehicle';
  // Veƒækoform√°t (generic) - Roll Materials, Large Format
  if (allText.includes('velkoformat') || allText.includes('large format') || allText.includes('roll material') || allText.includes('photo-poster') || allText.includes('blind-frame') || allText.includes('wallpaper') || allText.includes('window-graphic') || allText.includes('floor-graphic') || allText.includes('luminous') || allText.includes('reposition')) return 'largeformat';
  // Vizitky / Karty
  if (allText.includes('vizitk') || allText.includes('pf-ka') || allText.includes('pfka') || allText.includes('preukaz') || allText.includes('multiloft') || allText.includes('plastove vizitk') || allText.includes('transparentne vizitk') || allText.includes('vrstvene vizitk') || allText.includes('darcekova poukazka')) return 'card';
  // Let√°k / Flyer
  if (allText.includes('letak') || allText.includes('flyer') || allText.includes('hlavickovy') || allText.includes('diplom') || allText.includes('foto plaga')) return 'flyer';
  // Plag√°t / Poster
  if (allText.includes('plakat') || allText.includes('plagat') || allText.includes('poster')) return 'poster';
  // Pohƒæadnica / Pozv√°nka
  if (allText.includes('pohladnic') || allText.includes('pozvan') || allText.includes('oznameni')) return 'card';
  // Visaƒçka
  if (allText.includes('visack') || allText.includes('badge')) return 'card';
  // Papierov√Ω materi√°l / RFQ papiere
  if (allText.includes('papier') && (allText.includes('rfq') || allText.includes('rolove') || allText.includes('harkove') || allText.includes('plombovac'))) return 'largeformat';
  // Default
  return 'print';
}

// Build specs for each item with icons, units, product type
const itemsWithSpecs = items.map((item: any) => {
  const specs = Array.isArray(item.specs) && item.specs.length > 0
    ? item.specs
    : item.spec ? parseSpecString(item.spec) : [];
  let name = item.name || '';
  if (name.includes(' ‚Äî ')) {
    const [left, right] = name.split(' ‚Äî ');
    if (left.trim() === right.trim()) name = left.trim();
  }
  // Enrich specs with icons and units
  const enrichedSpecs = specs.map((s: any) => ({
    ...s,
    icon: getSpecIcon(s.label),
    unit: getSpecUnit(s.label, s.value),
  }));
  // Group specs into rows of 2
  const specRows: any[][] = [];
  for (let i = 0; i < enrichedSpecs.length; i += 2) {
    specRows.push(enrichedSpecs.slice(i, i + 2));
  }
  const productType = detectProductType(name, specs);
  return { ...item, name, parsedSpecs: enrichedSpecs, specRows, productType };
});

// Format currency
function formatCurrency(n: number): string {
  return new Intl.NumberFormat('sk-SK', { style: 'currency', currency: 'EUR' }).format(n || 0);
}
---

<Layout title="Dopyt na nacenenie">
  <main class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
    <div class="max-w-3xl mx-auto px-5 py-10">
      
      {/* Header */}
      <div class="text-center mb-8">
        {organization && (
          <div class="text-sm text-slate-400 mb-2">{organization.name}</div>
        )}
        <h1 class="text-3xl font-bold text-white mb-2">Dopyt na nacenenie</h1>
        {!isSubmitted && !isExpired && (
          <p class="text-slate-400">
            Pros√≠m, vypl≈àte ceny a term√≠n dodania pre polo≈æky ni≈æ≈°ie.
          </p>
        )}
      </div>

      {/* Expired State */}
      {isExpired && (
        <div class="glass rounded-3xl p-8 text-center mb-6 animate-fade-in-up">
          <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white mb-2">Dopyt expiroval</h3>
          <p class="text-slate-400">Tento dopyt u≈æ nie je platn√Ω. Kontaktujte zad√°vateƒæa pre aktu√°lny dopyt.</p>
        </div>
      )}

      {/* Error State */}
      {errorParam && !isSubmitted && (
        <div class="glass rounded-3xl p-8 text-center mb-6 animate-fade-in-up border border-red-500/30">
          <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white mb-2">Chyba pri odosielan√≠</h3>
          <p class="text-slate-400 mb-4">
            {errorParam === 'RFQ not found' ? 'Dopyt nebol n√°jden√Ω.' : 
             errorParam === 'Link expired' ? 'Platnos≈• odkazu vypr≈°ala.' :
             errorParam === 'Organization not found' ? 'Organiz√°cia nebola n√°jden√°.' :
             `Nastala chyba: ${errorParam}`}
          </p>
          <p class="text-sm text-slate-500">Sk√∫ste to znova alebo kontaktujte zad√°vateƒæa.</p>
        </div>
      )}

      {/* Success State */}
      {isSubmitted && (
        <div class="glass rounded-3xl p-8 text-center mb-6 animate-fade-in-up">
          <div class="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white mb-2">ƒéakujeme!</h3>
          <p class="text-slate-400">Va≈°a ponuka bola √∫spe≈°ne odoslan√°. Budeme v√°s kontaktova≈•.</p>
        </div>
      )}

      {/* RFQ Form */}
      {!isExpired && !isSubmitted && (
        <form 
          id="rfqForm"
          class="space-y-6"
          action={`/api/supplier-rfq/${token}/respond`}
          method="POST"
        >
          {/* Items */}
          <div class="space-y-4">
            {itemsWithSpecs.map((item: any, idx: number) => (
              <div class="glass rounded-2xl p-6 animate-fade-in-up" style={`animation-delay: ${idx * 0.1}s`}>
                {/* Product header with SVG illustration */}
                <div class="flex items-start gap-5 mb-5">
                  {/* Dynamic product SVG */}
                  <div class="flex-shrink-0 w-16 h-16 rounded-xl bg-gradient-to-br from-emerald-500/20 to-cyan-500/20 border border-emerald-500/20 flex items-center justify-center">
                    {item.productType === 'book' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <rect x="10" y="8" width="36" height="48" rx="2" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1"/>
                        <path d="M16 8V56" stroke="currentColor" stroke-width="2"/>
                        <line x1="22" y1="18" x2="40" y2="18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <line x1="22" y1="24" x2="36" y2="24" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <line x1="22" y1="30" x2="38" y2="30" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <rect x="22" y="36" width="16" height="10" rx="1" stroke="currentColor" stroke-width="1" fill="currentColor" fill-opacity="0.15"/>
                        <path d="M48 12C50 12 52 13 52 16V52C52 54 50 56 48 56" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-dasharray="3 2"/>
                      </svg>
                    )}
                    {item.productType === 'banner' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <rect x="8" y="12" width="48" height="32" rx="2" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1"/>
                        <circle cx="22" cy="26" r="4" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M14 38l8-8 6 6 8-10 14 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="6" y1="12" x2="6" y2="52" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <line x1="58" y1="12" x2="58" y2="52" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                    )}
                    {item.productType === 'sticker' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <rect x="12" y="12" width="40" height="40" rx="8" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1"/>
                        <path d="M36 12V28C36 30.2 37.8 32 40 32H52" stroke="currentColor" stroke-width="2"/>
                        <path d="M36 12L52 28V44C52 48.4 48.4 52 44 52H20C15.6 52 12 48.4 12 44V20C12 15.6 15.6 12 20 12H36Z" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.05"/>
                      </svg>
                    )}
                    {item.productType === 'flyer' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <rect x="14" y="8" width="36" height="48" rx="2" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1"/>
                        <line x1="20" y1="18" x2="44" y2="18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <line x1="20" y1="24" x2="38" y2="24" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <rect x="20" y="30" width="24" height="14" rx="1" stroke="currentColor" stroke-width="1" fill="currentColor" fill-opacity="0.15"/>
                        <line x1="20" y1="50" x2="44" y2="50" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                      </svg>
                    )}
                    {item.productType === 'card' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <rect x="8" y="16" width="48" height="32" rx="3" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1"/>
                        <line x1="16" y1="28" x2="36" y2="28" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <line x1="16" y1="34" x2="30" y2="34" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                        <line x1="16" y1="38" x2="28" y2="38" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                      </svg>
                    )}
                    {item.productType === 'billboard' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <rect x="6" y="8" width="52" height="28" rx="2" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1"/>
                        <line x1="24" y1="36" x2="24" y2="56" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="40" y1="36" x2="40" y2="56" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="18" y1="56" x2="46" y2="56" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="20" cy="20" r="4" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M12 32l10-10 8 8 8-12 14 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    )}
                    {item.productType === 'calendar' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <rect x="10" y="14" width="44" height="42" rx="3" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1"/>
                        <line x1="10" y1="26" x2="54" y2="26" stroke="currentColor" stroke-width="2"/>
                        <line x1="22" y1="8" x2="22" y2="20" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                        <line x1="42" y1="8" x2="42" y2="20" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                        <rect x="18" y="32" width="6" height="6" rx="1" fill="currentColor" fill-opacity="0.3"/>
                        <rect x="29" y="32" width="6" height="6" rx="1" fill="currentColor" fill-opacity="0.3"/>
                        <rect x="40" y="32" width="6" height="6" rx="1" fill="currentColor" fill-opacity="0.3"/>
                        <rect x="18" y="42" width="6" height="6" rx="1" fill="currentColor" fill-opacity="0.3"/>
                        <rect x="29" y="42" width="6" height="6" rx="1" fill="currentColor" fill-opacity="0.2"/>
                        <rect x="40" y="42" width="6" height="6" rx="1" fill="currentColor" fill-opacity="0.2"/>
                      </svg>
                    )}
                    {item.productType === 'wedding' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <rect x="12" y="10" width="40" height="44" rx="2" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.08"/>
                        <path d="M32 22C30 18 24 16 24 22c0 4 8 10 8 10s8-6 8-10c0-6-6-4-8 0z" fill="currentColor" fill-opacity="0.25" stroke="currentColor" stroke-width="1.5"/>
                        <line x1="22" y1="40" x2="42" y2="40" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                        <line x1="26" y1="44" x2="38" y2="44" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                        <path d="M20 10c2-4 6-4 8-2M44 10c-2-4-6-4-8-2" stroke="currentColor" stroke-width="1" stroke-linecap="round" opacity="0.5"/>
                      </svg>
                    )}
                    {item.productType === 'textile' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <path d="M18 14L10 24V28L18 22V54H46V22L54 28V24L46 14H38L34 20H30L26 14H18Z" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1" stroke-linejoin="round"/>
                        <line x1="26" y1="34" x2="38" y2="34" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
                        <line x1="28" y1="38" x2="36" y2="38" stroke="currentColor" stroke-width="1" stroke-linecap="round" opacity="0.4"/>
                      </svg>
                    )}
                    {item.productType === 'rollup' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <rect x="18" y="6" width="28" height="44" rx="1" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1"/>
                        <line x1="24" y1="16" x2="40" y2="16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <line x1="24" y1="22" x2="36" y2="22" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                        <rect x="24" y="28" width="16" height="10" rx="1" stroke="currentColor" stroke-width="1" fill="currentColor" fill-opacity="0.15"/>
                        <ellipse cx="32" cy="52" rx="14" ry="3" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1"/>
                        <line x1="24" y1="50" x2="18" y2="58" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <line x1="40" y1="50" x2="46" y2="58" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                      </svg>
                    )}
                    {item.productType === 'vehicle' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <path d="M6 38h52M10 38l4-14h22l8 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M6 38v6h8m0 0a4 4 0 108 0m-8 0h8m22-6v6h-8m0 0a4 4 0 11-8 0m8 0h-8" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1"/>
                        <rect x="18" y="28" width="16" height="8" rx="1" stroke="currentColor" stroke-width="1" fill="currentColor" fill-opacity="0.2"/>
                        <line x1="38" y1="30" x2="48" y2="30" stroke="currentColor" stroke-width="1" stroke-linecap="round" opacity="0.5"/>
                      </svg>
                    )}
                    {item.productType === '3d' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <path d="M32 6L54 18V46L32 58L10 46V18L32 6Z" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.08"/>
                        <line x1="32" y1="6" x2="32" y2="58" stroke="currentColor" stroke-width="1.5" opacity="0.5"/>
                        <line x1="10" y1="18" x2="32" y2="32" stroke="currentColor" stroke-width="1.5" opacity="0.5"/>
                        <line x1="54" y1="18" x2="32" y2="32" stroke="currentColor" stroke-width="1.5" opacity="0.5"/>
                        <text x="22" y="40" font-size="16" font-weight="bold" fill="currentColor" fill-opacity="0.4">3D</text>
                      </svg>
                    )}
                    {item.productType === 'folder' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <path d="M8 14h18l4 4h26v36H8V14z" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1" stroke-linejoin="round"/>
                        <line x1="16" y1="30" x2="48" y2="30" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <line x1="16" y1="36" x2="40" y2="36" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                        <line x1="16" y1="42" x2="44" y2="42" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                      </svg>
                    )}
                    {item.productType === 'gamecard' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <rect x="10" y="12" width="28" height="40" rx="3" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1"/>
                        <rect x="26" y="16" width="28" height="40" rx="3" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.06"/>
                        <circle cx="24" cy="24" r="4" stroke="currentColor" stroke-width="1.5"/>
                        <text x="18" y="46" font-size="14" font-weight="bold" fill="currentColor" fill-opacity="0.3">‚ô†</text>
                      </svg>
                    )}
                    {item.productType === 'plate' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <rect x="8" y="14" width="48" height="36" rx="2" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1"/>
                        <rect x="8" y="14" width="48" height="36" rx="2" stroke="currentColor" stroke-width="2"/>
                        <line x1="8" y1="18" x2="56" y2="18" stroke="currentColor" stroke-width="1.5" opacity="0.4"/>
                        <line x1="16" y1="26" x2="48" y2="26" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <line x1="16" y1="32" x2="40" y2="32" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                        <line x1="16" y1="38" x2="44" y2="38" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                        <path d="M8 50l6-6h36l6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" opacity="0.3"/>
                      </svg>
                    )}
                    {item.productType === 'largeformat' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <rect x="4" y="10" width="56" height="36" rx="2" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1"/>
                        <circle cx="18" cy="24" r="5" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M8 42l12-12 10 10 8-8 18 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <ellipse cx="32" cy="52" rx="12" ry="3" stroke="currentColor" stroke-width="1.5" fill="currentColor" fill-opacity="0.1"/>
                      </svg>
                    )}
                    {item.productType === 'poster' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <rect x="12" y="6" width="40" height="52" rx="2" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1"/>
                        <rect x="18" y="14" width="28" height="16" rx="1" stroke="currentColor" stroke-width="1.5" fill="currentColor" fill-opacity="0.15"/>
                        <line x1="18" y1="38" x2="46" y2="38" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <line x1="18" y1="44" x2="38" y2="44" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <line x1="18" y1="50" x2="42" y2="50" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                      </svg>
                    )}
                    {item.productType === 'print' && (
                      <svg class="w-9 h-9 text-emerald-400" viewBox="0 0 64 64" fill="none">
                        <rect x="12" y="6" width="40" height="52" rx="3" stroke="currentColor" stroke-width="2" fill="currentColor" fill-opacity="0.1"/>
                        <line x1="20" y1="16" x2="44" y2="16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <line x1="20" y1="22" x2="38" y2="22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <line x1="20" y1="28" x2="40" y2="28" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                        <line x1="20" y1="34" x2="36" y2="34" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                        <rect x="20" y="40" width="24" height="12" rx="1" stroke="currentColor" stroke-width="1" fill="currentColor" fill-opacity="0.1"/>
                      </svg>
                    )}
                  </div>

                  <div class="flex-1 min-w-0">
                    <h3 class="font-semibold text-white text-lg leading-tight">{item.name || `Polo≈æka ${idx + 1}`}</h3>
                    <div class="flex items-center gap-3 mt-1.5">
                      <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-500/15 text-emerald-400 border border-emerald-500/20">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                        {item.qty || 1} ks
                      </span>
                      <div id={`total-display-${idx}`} class="hidden">
                        <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-500/15 text-blue-400 border border-blue-500/20">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.121 15.536c-1.171 1.952-3.07 1.952-4.242 0-1.172-1.953-1.172-5.119 0-7.072 1.171-1.952 3.07-1.952 4.242 0M8 10.5h4m-4 3h4m9-1.5a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                          <span id={`total-value-${idx}`}>0.00</span> ‚Ç¨
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Specs table with icons and units */}
                {item.specRows.length > 0 ? (
                  <div class="bg-slate-800/40 rounded-xl p-4 mb-5 border border-slate-700/50">
                    <div class="flex items-center gap-2 mb-3">
                      <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                      <span class="text-xs font-medium text-slate-500 uppercase tracking-wider">≈†pecifik√°cia</span>
                    </div>
                    <table class="text-sm w-full" style="border-collapse: collapse;">
                      <tbody>
                        {item.specRows.map((row: any[]) => (
                          <tr class="border-b border-slate-700/30 last:border-0">
                            <td class="py-2 pr-2 align-top" style="width: 1%;">
                              <svg class="w-3.5 h-3.5 text-slate-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d={row[0].icon}/></svg>
                            </td>
                            <td class="text-slate-500 py-2 pr-1 whitespace-nowrap align-top text-xs">{row[0].label}:</td>
                            <td class="text-slate-200 font-medium py-2 pr-6 align-top" style="word-break: break-word;">
                              {row[0].value}{row[0].unit ? <span class="text-slate-500 text-xs ml-1">{row[0].unit}</span> : null}
                            </td>
                            {row[1] ? (
                              <Fragment>
                                <td class="py-2 pr-2 align-top" style="width: 1%;">
                                  <svg class="w-3.5 h-3.5 text-slate-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d={row[1].icon}/></svg>
                                </td>
                                <td class="text-slate-500 py-2 pr-1 whitespace-nowrap align-top text-xs">{row[1].label}:</td>
                                <td class="text-slate-200 font-medium py-2 align-top" style="word-break: break-word;">
                                  {row[1].value}{row[1].unit ? <span class="text-slate-500 text-xs ml-1">{row[1].unit}</span> : null}
                                </td>
                              </Fragment>
                            ) : (
                              <Fragment>
                                <td></td><td></td><td></td>
                              </Fragment>
                            )}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : null}

                <div class="flex justify-between items-start mb-4">
                  <div class="flex-1"></div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  {/* Unit Price */}
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">Jedn. cena (‚Ç¨)</label>
                    <input
                      type="number"
                      name={`items[${idx}][unitPrice]`}
                      step="0.0001"
                      required
                      data-idx={idx}
                      data-qty={item.qty || 1}
                      class="unit-price-input w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                      placeholder="Cena za 1 ks"
                    />
                    <div class="text-xs text-slate-500 mt-1">za 1 kus</div>
                  </div>

                  {/* Total Price */}
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">Celkom (‚Ç¨)</label>
                    <input
                      type="number"
                      step="0.01"
                      data-idx={idx}
                      data-qty={item.qty || 1}
                      class="total-price-input w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="Celkov√° cena"
                    />
                    <div class="text-xs text-slate-500 mt-1">za {item.qty || 1} ks</div>
                  </div>

                  {/* VAT */}
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">DPH (%)</label>
                    <input
                      type="number"
                      name={`items[${idx}][vatRate]`}
                      step="1"
                      value={defaultVatRate}
                      class="w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 text-white"
                    />
                  </div>

                  {/* Lead Time */}
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">Dodanie (dni)</label>
                    <input
                      type="number"
                      name={`items[${idx}][leadTimeDays]`}
                      step="1"
                      placeholder="napr. 7"
                      class="w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500"
                    />
                  </div>
                </div>

                {/* Tip */}
                <div class="mt-4 text-xs text-slate-500 bg-slate-800/30 rounded-lg p-3">
                  üí° Tip: Zadajte cenu za 1 ks alebo celkov√∫ cenu - druh√© pole sa automaticky prepoƒç√≠ta.
                </div>

                {/* Hidden fields */}
                <input type="hidden" name={`items[${idx}][itemId]`} value={item.itemId || item.id || ''} />
                <input type="hidden" name={`items[${idx}][qty]`} value={item.qty || 1} />
              </div>
            ))}
          </div>

          {/* Supplier Info */}
          <div class="glass rounded-2xl p-6 animate-fade-in-up">
            <h3 class="font-semibold text-white mb-4">Va≈°e kontaktn√© √∫daje</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-slate-400 mb-1">Va≈°e meno / firma</label>
                <input
                  type="text"
                  name="supplierName"
                  class="w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500"
                  placeholder="N√°zov firmy alebo meno"
                />
              </div>
              <div>
                <label class="block text-sm text-slate-400 mb-1">V√°≈° e-mail</label>
                <input
                  type="email"
                  name="supplierEmail"
                  class="w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500"
                  placeholder="vas@email.sk"
                />
              </div>
            </div>

            <div class="mt-4">
              <label class="block text-sm text-slate-400 mb-1">Pozn√°mka (voliteƒæn√©)</label>
              <textarea
                name="notes"
                rows="3"
                class="w-full bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500"
                placeholder="Ak√©koƒævek dodatoƒçn√© inform√°cie k ponuke..."
              ></textarea>
            </div>
          </div>

          {/* Submit Button */}
          <button
            type="submit"
            class="w-full py-5 rounded-2xl text-xl font-bold text-white bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 shadow-lg shadow-emerald-500/20 hover:shadow-xl hover:shadow-emerald-500/30 transition-all duration-200 flex items-center justify-center gap-3"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
            Odosla≈• ponuku
          </button>
        </form>
      )}

      {/* Company Footer */}
      {organization && (
        <div class="mt-12 text-center text-sm text-slate-500">
          <div class="font-medium text-slate-400">{organization.name}</div>
          {organization.address && <div>{organization.address}</div>}
          <div class="flex flex-wrap justify-center gap-x-4 gap-y-1 mt-1">
            {organization.ico && <span>IƒåO: {organization.ico}</span>}
            {organization.email && <span>{organization.email}</span>}
            {organization.phone && <span>{organization.phone}</span>}
          </div>
        </div>
      )}
    </div>
  </main>
</Layout>

<script>
  // Price calculation - sync unit price and total price
  document.querySelectorAll('.unit-price-input').forEach((input) => {
    input.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      const idx = target.dataset.idx;
      const qty = parseFloat(target.dataset.qty || '1');
      const unitPrice = parseFloat(target.value.replace(',', '.')) || 0;
      
      if (unitPrice >= 0 && qty > 0) {
        const total = unitPrice * qty;
        const totalInput = document.querySelector(`.total-price-input[data-idx="${idx}"]`) as HTMLInputElement;
        if (totalInput) {
          totalInput.value = total.toFixed(2);
        }
        
        // Update display
        const displayEl = document.getElementById(`total-display-${idx}`);
        const valueEl = document.getElementById(`total-value-${idx}`);
        if (displayEl && valueEl && total > 0) {
          displayEl.classList.remove('hidden');
          valueEl.textContent = total.toFixed(2);
        }
      }
    });
  });

  document.querySelectorAll('.total-price-input').forEach((input) => {
    input.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      const idx = target.dataset.idx;
      const qty = parseFloat(target.dataset.qty || '1');
      const totalPrice = parseFloat(target.value.replace(',', '.')) || 0;
      
      if (totalPrice >= 0 && qty > 0) {
        const unitPrice = totalPrice / qty;
        const unitInput = document.querySelector(`.unit-price-input[data-idx="${idx}"]`) as HTMLInputElement;
        if (unitInput) {
          unitInput.value = unitPrice.toFixed(4);
        }
        
        // Update display
        const displayEl = document.getElementById(`total-display-${idx}`);
        const valueEl = document.getElementById(`total-value-${idx}`);
        if (displayEl && valueEl && totalPrice > 0) {
          displayEl.classList.remove('hidden');
          valueEl.textContent = totalPrice.toFixed(2);
        }
      }
    });
  });
</script>
