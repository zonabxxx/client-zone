---
import Layout from '../layouts/Layout.astro';
import { getSessionFromCookie } from '../lib/session';
import { getClientCalculations, getOrderByCalculationId, getClientProjects, type Project, type Calculation } from '../lib/db';
import DashboardHeader from '../components/DashboardHeader.astro';
import Navigation from '../components/Navigation.astro';
import { format } from 'date-fns';
import { sk } from 'date-fns/locale';

const session = getSessionFromCookie(Astro.request.headers.get('cookie'));

if (!session) {
  return Astro.redirect('/');
}

// Load projects and calculations
const projectsResult = await getClientProjects(session.customerId, session.customerName, { limit: 50, offset: 0 });
const result = await getClientCalculations(session.customerId, session.customerName, { limit: 100, offset: 0 });

// Get order IDs for calculations (to link to existing quote pages)
const calculationsWithOrders = await Promise.all(
  result.items.map(async (calc) => {
    const order = await getOrderByCalculationId(calc.id);
    return {
      ...calc,
      orderId: order?.id || null,
    };
  })
);

const calculations = calculationsWithOrders;
const projects = projectsResult.items;

// Group calculations by project
const projectsMap = new Map<string, { project: Project; calculations: typeof calculations }>();

// Add projects with empty calculation arrays
for (const project of projects) {
  projectsMap.set(project.id, { project, calculations: [] });
}

// Add calculations without project as "Nezaraden√©"
const unassignedCalcs: typeof calculations = [];

for (const calc of calculations) {
  if (calc.projectId && projectsMap.has(calc.projectId)) {
    projectsMap.get(calc.projectId)!.calculations.push(calc);
  } else {
    unassignedCalcs.push(calc);
  }
}

// Convert to array and sort by project name
const groupedProjects = Array.from(projectsMap.values())
  .filter(g => g.calculations.length > 0)
  .sort((a, b) => a.project.name.localeCompare(b.project.name));

const hasMore = result.hasMore;
const totalCount = result.total;

// Stats
const stats = {
  total: totalCount,
  projects: groupedProjects.length,
  approved: calculations.filter(c => c.approvalStatus === 'CLIENT_APPROVED').length,
  pending: calculations.filter(c => c.approvalStatus === 'CLIENT_VIEWED').length,
};

// Approval status labels and colors
const statusConfig: Record<string, { label: string; color: string; bgColor: string }> = {
  'DRAFT': { label: 'V pr√≠prave', color: 'text-slate-400', bgColor: 'bg-slate-500/20' },
  'CLIENT_VIEWED': { label: 'ƒåak√° na schv√°lenie', color: 'text-amber-400', bgColor: 'bg-amber-500/20' },
  'CLIENT_APPROVED': { label: 'Schv√°len√©', color: 'text-emerald-400', bgColor: 'bg-emerald-500/20' },
  'CLIENT_REJECTED': { label: 'Zamietnut√©', color: 'text-red-400', bgColor: 'bg-red-500/20' },
  'CLIENT_REQUESTED_CHANGES': { label: 'Po≈æadovan√© zmeny', color: 'text-orange-400', bgColor: 'bg-orange-500/20' },
};

function formatDate(date: Date | null): string {
  if (!date) return '‚Äî';
  try {
    return format(date, 'd. MMM yyyy', { locale: sk });
  } catch {
    return '‚Äî';
  }
}
---

<Layout title="Cenov√© ponuky">
  <main class="min-h-screen">
    <DashboardHeader customerName={session.customerName} />
    
    <div class="max-w-6xl mx-auto px-4 py-8">
      <Navigation active="quotes" />
      
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="glass rounded-2xl p-6 animate-fade-in-up">
          <div class="text-3xl font-bold text-white mb-1">{stats.total}</div>
          <div class="text-slate-400 text-sm">Celkom pon√∫k</div>
        </div>
        <div class="glass rounded-2xl p-6 animate-fade-in-up stagger-1">
          <div class="text-3xl font-bold text-blue-400 mb-1">{stats.projects}</div>
          <div class="text-slate-400 text-sm">Projektov</div>
        </div>
        <div class="glass rounded-2xl p-6 animate-fade-in-up stagger-2 border border-emerald-500/30 bg-emerald-500/5">
          <div class="text-3xl font-bold text-emerald-400 mb-1">{stats.approved}</div>
          <div class="text-slate-400 text-sm">Schv√°len√Ωch</div>
        </div>
        <div class="glass rounded-2xl p-6 animate-fade-in-up stagger-3">
          <div class="text-3xl font-bold text-amber-400 mb-1">{stats.pending}</div>
          <div class="text-slate-400 text-sm">ƒåak√° na v√°s</div>
        </div>
      </div>

      <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
        <button data-filter="all" class="filter-btn active px-4 py-2 rounded-xl text-sm font-medium transition-all">
          V≈°etky
        </button>
        <button data-filter="pending" class="filter-btn px-4 py-2 rounded-xl text-sm font-medium transition-all">
          Na schv√°lenie
        </button>
        <button data-filter="approved" class="filter-btn px-4 py-2 rounded-xl text-sm font-medium transition-all">
          Schv√°len√©
        </button>
        <button data-filter="draft" class="filter-btn px-4 py-2 rounded-xl text-sm font-medium transition-all">
          V pr√≠prave
        </button>
      </div>

      {calculations.length === 0 ? (
        <div class="glass rounded-3xl p-12 text-center animate-fade-in-up">
          <div class="text-6xl mb-4">üí∞</div>
          <h2 class="text-xl font-semibold text-white mb-2">Zatiaƒæ ≈æiadne cenov√© ponuky</h2>
          <p class="text-slate-400">Va≈°e cenov√© ponuky sa tu zobrazia hneƒè ako bud√∫ vytvoren√©.</p>
        </div>
      ) : (
        <div class="space-y-6" id="calculationsContainer">
          {/* Projects with calculations */}
          {groupedProjects.map((group, projectIndex) => {
            const projectApproved = group.calculations.filter(c => c.approvalStatus === 'CLIENT_APPROVED').length;
            const projectTotal = group.calculations.length;
            const allApproved = projectApproved === projectTotal;
            
            return (
              <details 
                class={`project-group rounded-2xl overflow-hidden animate-fade-in-up ${allApproved ? 'border-2 border-emerald-500/50 bg-emerald-500/10' : 'glass'}`}
                style={`animation-delay: ${projectIndex * 50}ms`}
                open
              >
                <summary class="flex items-center justify-between p-5 cursor-pointer hover:bg-white/5 transition-colors">
                  <div class="flex items-center gap-4">
                    <span class="text-2xl">üìÅ</span>
                    <div>
                      <h3 class="text-lg font-semibold text-white">{group.project.name}</h3>
                      <div class="flex items-center gap-3 text-sm text-slate-400">
                        <span>{projectTotal} {projectTotal === 1 ? 'ponuka' : projectTotal < 5 ? 'ponuky' : 'pon√∫k'}</span>
                        {projectApproved > 0 && (
                          <span class="flex items-center gap-1 text-emerald-400">
                            <span>‚úÖ</span> {projectApproved} schv√°len√Ωch
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                  <div class="flex items-center gap-4">
                    <div class="text-right">
                      <div class="text-lg font-bold text-emerald-400">
                        {group.project.totalPrice?.toLocaleString('sk-SK', { minimumFractionDigits: 2 }) || '0,00'} ‚Ç¨
                      </div>
                      <div class="text-xs text-slate-400">Celkom</div>
                    </div>
                    <svg class="w-5 h-5 text-slate-400 transition-transform project-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </div>
                </summary>
                
                <div class="border-t border-white/10 bg-black/20">
                  <div class="p-4 space-y-3">
                    {group.calculations.map((calc) => {
                      const status = statusConfig[calc.approvalStatus] || statusConfig['DRAFT'];
                      const isApproved = calc.approvalStatus === 'CLIENT_APPROVED';
                      const quoteUrl = calc.orderId ? `/order/${calc.orderId}/quote?from=quotes` : null;
                      
                      return (
                        <a 
                          href={quoteUrl || '#'}
                          class={`calculation-card block rounded-xl p-4 transition-all cursor-pointer ${quoteUrl ? '' : 'pointer-events-none'} ${isApproved ? 'bg-emerald-500/15 hover:bg-emerald-500/25' : 'bg-white/5 hover:bg-white/10'}`}
                          data-status={calc.approvalStatus}
                        >
                          <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
                            <div class="flex-1">
                              <div class="flex items-center gap-2 mb-1">
                                <span class="text-lg">{isApproved ? '‚úÖ' : 'üí∞'}</span>
                                <span class="font-mono text-xs text-blue-400">{calc.calculationNumber}</span>
                                {isApproved ? (
                                  <span class="px-2 py-0.5 bg-emerald-500 text-white text-xs font-bold rounded-full">
                                    SCHV√ÅLEN√â
                                  </span>
                                ) : (
                                  <span class={`px-2 py-0.5 rounded-full text-xs font-medium ${status.color} ${status.bgColor}`}>
                                    {status.label}
                                  </span>
                                )}
                              </div>
                              <h4 class={`font-medium ${isApproved ? 'text-emerald-100' : 'text-white'}`}>{calc.name}</h4>
                              <div class="text-xs text-slate-400 mt-1">üìÖ {formatDate(calc.updatedAt)}</div>
                            </div>
                            
                            <div class="flex items-center gap-3">
                              {calc.totalPrice && calc.totalPrice > 0 && (
                                <div class={`text-lg font-bold ${isApproved ? 'text-emerald-300' : 'text-emerald-400'}`}>
                                  {calc.totalPrice.toLocaleString('sk-SK', { minimumFractionDigits: 2 })} ‚Ç¨
                                </div>
                              )}
                              {quoteUrl ? (
                                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                              ) : (
                                <span class="text-xs text-slate-500">‚è≥</span>
                              )}
                            </div>
                          </div>
                        </a>
                      );
                    })}
                  </div>
                </div>
              </details>
            );
          })}

          {/* Unassigned calculations */}
          {unassignedCalcs.length > 0 && (
            <details 
              class="project-group glass rounded-2xl overflow-hidden animate-fade-in-up"
              open
            >
              <summary class="flex items-center justify-between p-5 cursor-pointer hover:bg-white/5 transition-colors">
                <div class="flex items-center gap-4">
                  <span class="text-2xl">üìã</span>
                  <div>
                    <h3 class="text-lg font-semibold text-white">Nezaraden√© ponuky</h3>
                    <div class="text-sm text-slate-400">{unassignedCalcs.length} pon√∫k bez projektu</div>
                  </div>
                </div>
                <svg class="w-5 h-5 text-slate-400 transition-transform project-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </summary>
              
              <div class="border-t border-white/10 bg-black/20">
                <div class="p-4 space-y-3">
                  {unassignedCalcs.map((calc) => {
                    const status = statusConfig[calc.approvalStatus] || statusConfig['DRAFT'];
                    const isApproved = calc.approvalStatus === 'CLIENT_APPROVED';
                    const quoteUrl = calc.orderId ? `/order/${calc.orderId}/quote?from=quotes` : null;
                    
                    return (
                      <a 
                        href={quoteUrl || '#'}
                        class={`calculation-card block rounded-xl p-4 transition-all cursor-pointer ${quoteUrl ? '' : 'pointer-events-none'} ${isApproved ? 'bg-emerald-500/15 hover:bg-emerald-500/25' : 'bg-white/5 hover:bg-white/10'}`}
                        data-status={calc.approvalStatus}
                      >
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
                          <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                              <span class="text-lg">{isApproved ? '‚úÖ' : 'üí∞'}</span>
                              <span class="font-mono text-xs text-blue-400">{calc.calculationNumber}</span>
                              {isApproved ? (
                                <span class="px-2 py-0.5 bg-emerald-500 text-white text-xs font-bold rounded-full">
                                  SCHV√ÅLEN√â
                                </span>
                              ) : (
                                <span class={`px-2 py-0.5 rounded-full text-xs font-medium ${status.color} ${status.bgColor}`}>
                                  {status.label}
                                </span>
                              )}
                            </div>
                            <h4 class={`font-medium ${isApproved ? 'text-emerald-100' : 'text-white'}`}>{calc.name}</h4>
                            <div class="text-xs text-slate-400 mt-1">üìÖ {formatDate(calc.updatedAt)}</div>
                          </div>
                          
                          <div class="flex items-center gap-3">
                            {calc.totalPrice && calc.totalPrice > 0 && (
                              <div class={`text-lg font-bold ${isApproved ? 'text-emerald-300' : 'text-emerald-400'}`}>
                                {calc.totalPrice.toLocaleString('sk-SK', { minimumFractionDigits: 2 })} ‚Ç¨
                              </div>
                            )}
                            {quoteUrl ? (
                              <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                              </svg>
                            ) : (
                              <span class="text-xs text-slate-500">‚è≥</span>
                            )}
                          </div>
                        </div>
                      </a>
                    );
                  })}
                </div>
              </div>
            </details>
          )}
        </div>
      )}
    </div>
  </main>
</Layout>

<style>
  .filter-btn {
    background: rgba(255, 255, 255, 0.05);
    color: #94a3b8;
    border: 1px solid transparent;
  }
  
  .filter-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #e2e8f0;
  }
  
  .filter-btn.active {
    background: #0552b5;
    color: white;
    border-color: #0967d2;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .loading-spinner {
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  /* Project accordion */
  .project-group summary {
    list-style: none;
  }
  
  .project-group summary::-webkit-details-marker {
    display: none;
  }
  
  .project-group[open] .project-chevron {
    transform: rotate(180deg);
  }
  
  .project-group summary:focus {
    outline: none;
  }
</style>

<script>
  // Filter functionality
  const filterBtns = document.querySelectorAll('.filter-btn');
  
  function updateFilters() {
    const calcCards = document.querySelectorAll('.calculation-card');
    const activeBtn = document.querySelector('.filter-btn.active');
    const filter = activeBtn?.getAttribute('data-filter') || 'all';
    
    calcCards.forEach(card => {
      const status = card.getAttribute('data-status');
      let show = true;
      if (filter === 'pending') show = status === 'CLIENT_VIEWED';
      if (filter === 'approved') show = status === 'CLIENT_APPROVED';
      if (filter === 'draft') show = status === 'DRAFT';
      (card as HTMLElement).style.display = show ? 'block' : 'none';
    });
  }
  
  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      filterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      updateFilters();
    });
  });
  
  // Load more functionality
  const loadMoreBtn = document.getElementById('loadMoreBtn') as HTMLButtonElement | null;
  const container = document.getElementById('calculationsContainer');
  
  if (loadMoreBtn && container) {
    loadMoreBtn.addEventListener('click', async () => {
      const offset = parseInt(loadMoreBtn.dataset.offset || '20');
      
      loadMoreBtn.disabled = true;
      loadMoreBtn.innerHTML = '<span class="loading-spinner inline-block w-5 h-5 border-2 border-white border-t-transparent rounded-full"></span> Naƒç√≠tavam...';
      
      try {
        const url = `/api/calculations?offset=${offset}&limit=20`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.items && data.items.length > 0) {
          // Render new items
          for (const calc of data.items) {
            const isApproved = calc.approvalStatus === 'CLIENT_APPROVED';
            const hasShareLink = calc.shareToken && calc.shareExpiresAt && new Date(calc.shareExpiresAt) > new Date();
            
            const card = document.createElement('div');
            card.className = isApproved 
              ? 'calculation-card rounded-2xl p-6 transition-all animate-fade-in-up bg-emerald-500/20 border-2 border-emerald-500/50 hover:bg-emerald-500/25'
              : 'calculation-card rounded-2xl p-6 transition-all animate-fade-in-up glass hover:bg-white/5';
            card.dataset.status = calc.approvalStatus;
            
            card.innerHTML = `
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="flex-1">
                  <div class="flex items-center gap-3 mb-2">
                    <span class="text-2xl">${isApproved ? '‚úÖ' : 'üí∞'}</span>
                    <div>
                      <div class="flex items-center gap-2 mb-1">
                        <span class="font-mono text-xs text-blue-400">${calc.calculationNumber}</span>
                        ${isApproved 
                          ? '<span class="px-2 py-0.5 bg-emerald-500 text-white text-xs font-bold rounded-full">SCHV√ÅLEN√â</span>'
                          : `<span class="px-2 py-0.5 rounded-full text-xs font-medium ${calc.approvalStatus === 'CLIENT_VIEWED' ? 'text-amber-400 bg-amber-500/20' : 'text-slate-400 bg-slate-500/20'}">${calc.approvalStatus === 'CLIENT_VIEWED' ? 'ƒåak√° na schv√°lenie' : 'V pr√≠prave'}</span>`
                        }
                      </div>
                      <h3 class="text-lg font-semibold ${isApproved ? 'text-emerald-100' : 'text-white'}">${calc.name}</h3>
                    </div>
                  </div>
                  ${isApproved ? `
                    <div class="mt-3 flex items-center gap-2 text-sm text-emerald-300">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                      </svg>
                      <span>T√°to cenov√° ponuka bola schv√°len√°. Z√°kazka je v realiz√°cii.</span>
                    </div>
                  ` : ''}
                </div>
                <div class="flex items-center gap-4">
                  ${calc.totalPrice ? `
                    <div class="text-right">
                      <div class="text-xl font-bold ${isApproved ? 'text-emerald-300' : 'text-emerald-400'}">
                        ${calc.totalPrice.toLocaleString('sk-SK', { minimumFractionDigits: 2 })} ‚Ç¨
                      </div>
                      <div class="text-xs text-slate-400">Celkov√° cena</div>
                    </div>
                  ` : ''}
                  ${hasShareLink ? `
                    <a 
                      href="https://app.adsun.sk/public/quote/${calc.id}/${calc.shareToken}"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-xl transition-all shadow-lg ${isApproved ? 'bg-emerald-600 hover:bg-emerald-500 text-white shadow-emerald-600/20' : 'bg-gradient-to-r from-primary-600 to-primary-500 hover:from-primary-500 hover:to-primary-400 text-white shadow-primary-600/20'}"
                    >
                      <span>${isApproved ? 'Detail ponuky' : 'Zobrazi≈• ponuku'}</span>
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                      </svg>
                    </a>
                  ` : ''}
                </div>
              </div>
            `;
            
            // Insert before load more button container
            loadMoreBtn.parentElement?.parentElement?.insertBefore(card, loadMoreBtn.parentElement);
          }
          
          // Update button
          const newOffset = offset + data.items.length;
          if (data.hasMore) {
            const remaining = data.total - newOffset;
            loadMoreBtn.dataset.offset = newOffset.toString();
            loadMoreBtn.innerHTML = `Naƒç√≠ta≈• viac (${remaining} zost√°va)`;
            loadMoreBtn.disabled = false;
          } else {
            loadMoreBtn.parentElement?.remove();
          }
          
          // Reapply filters
          updateFilters();
        }
      } catch (error) {
        console.error('Error loading more:', error);
        loadMoreBtn.innerHTML = 'Chyba, sk√∫ste znova';
        loadMoreBtn.disabled = false;
      }
    });
  }
</script>
