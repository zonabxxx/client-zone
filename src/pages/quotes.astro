---
import Layout from '../layouts/Layout.astro';
import { getSessionFromCookie } from '../lib/session';
import { getClientCalculations, getOrderByCalculationId, getClientProjects, type Project, type Calculation } from '../lib/db';
import { format } from 'date-fns';
import { sk } from 'date-fns/locale';

const session = getSessionFromCookie(Astro.request.headers.get('cookie'));

if (!session) {
  return Astro.redirect('/');
}

// Load projects and calculations
const projectsResult = await getClientProjects(session.customerId, session.customerName, { limit: 50, offset: 0 });
const result = await getClientCalculations(session.customerId, session.customerName, { limit: 100, offset: 0 });

// Get order IDs for calculations (to link to existing quote pages)
const calculationsWithOrders = await Promise.all(
  result.items.map(async (calc) => {
    const order = await getOrderByCalculationId(calc.id);
    return {
      ...calc,
      orderId: order?.id || null,
    };
  })
);

const calculations = calculationsWithOrders;
const projects = projectsResult.items;

// Group calculations by project
const projectsMap = new Map<string, { project: Project; calculations: typeof calculations }>();

// Add projects with empty calculation arrays
for (const project of projects) {
  projectsMap.set(project.id, { project, calculations: [] });
}

// Add calculations without project as "Nezaradené"
const unassignedCalcs: typeof calculations = [];

for (const calc of calculations) {
  if (calc.projectId && projectsMap.has(calc.projectId)) {
    projectsMap.get(calc.projectId)!.calculations.push(calc);
  } else {
    unassignedCalcs.push(calc);
  }
}

// Sort calculations within each project by date (newest first)
for (const group of projectsMap.values()) {
  group.calculations.sort((a, b) => {
    const dateA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
    const dateB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
    return dateB - dateA; // Newest first
  });
}

// Sort unassigned calculations by date (newest first)
unassignedCalcs.sort((a, b) => {
  const dateA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
  const dateB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
  return dateB - dateA; // Newest first
});

// Convert to array and sort by newest calculation date (newest project first)
const groupedProjects = Array.from(projectsMap.values())
  .filter(g => g.calculations.length > 0)
  .sort((a, b) => {
    // Get the newest calculation date from each project
    const latestA = a.calculations[0]?.createdAt ? new Date(a.calculations[0].createdAt).getTime() : 0;
    const latestB = b.calculations[0]?.createdAt ? new Date(b.calculations[0].createdAt).getTime() : 0;
    return latestB - latestA; // Newest project first
  });

const hasMore = result.hasMore;
const totalCount = result.total;

// Stats
const stats = {
  total: totalCount,
  projects: groupedProjects.length,
  approved: calculations.filter(c => c.approvalStatus === 'CLIENT_APPROVED').length,
  pending: calculations.filter(c => c.approvalStatus === 'CLIENT_VIEWED').length,
};

// Approval status labels and colors - ADSUN style
const statusConfig: Record<string, { label: string; cssClass: string }> = {
  'DRAFT': { label: 'V príprave', cssClass: 'status-draft' },
  'CLIENT_VIEWED': { label: 'Čaká na schválenie', cssClass: 'status-in-progress' },
  'CLIENT_APPROVED': { label: 'Schválené', cssClass: 'status-completed' },
  'CLIENT_REJECTED': { label: 'Zamietnuté', cssClass: 'status-cancelled' },
  'CLIENT_REQUESTED_CHANGES': { label: 'Požadované zmeny', cssClass: 'status-in-progress' },
};

function formatDate(date: Date | null): string {
  if (!date) return '—';
  try {
    return format(date, 'd. MMM yyyy', { locale: sk });
  } catch {
    return '—';
  }
}
---

<Layout title="Cenové ponuky" activeNav="quotes">
  <main class="min-h-screen pb-24 md:pb-8 overflow-x-hidden">
    <!-- Header -->
    <header class="px-4 py-6 md:px-8 md:py-8">
      <div class="max-w-6xl mx-auto">
        <!-- Breadcrumb -->
        <div class="flex items-center gap-2 text-sm text-[#6b7280] mb-6">
          <a href="/dashboard" class="hover:text-[#f59e0b] transition-colors flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
            Domov
          </a>
        </div>
        
        <!-- Title section -->
        <div>
          <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">
            <span class="text-gradient-orange">Cenové</span> ponuky
          </h1>
          <p class="text-[#9ca3af]">
            Prehľad a schvaľovanie cenových ponúk
          </p>
        </div>
        
        <!-- Orange divider -->
        <hr class="divider-orange mt-6" />
      </div>
    </header>
    
    <div class="max-w-6xl mx-auto px-4 md:px-8">
      <!-- Stats Grid -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-8">
        <div class="adsun-card p-4 md:p-6 animate-fade-in-up">
          <div class="stats-number text-white mb-1">{stats.total}</div>
          <div class="text-[#6b7280] text-xs md:text-sm">Celkom ponúk</div>
        </div>
        <div class="adsun-card p-4 md:p-6 animate-fade-in-up stagger-1">
          <div class="stats-number stats-number-blue mb-1">{stats.projects}</div>
          <div class="text-[#6b7280] text-xs md:text-sm">Projektov</div>
        </div>
        <div class="adsun-card adsun-card-active p-4 md:p-6 animate-fade-in-up stagger-2">
          <div class="stats-number stats-number-green mb-1">{stats.approved}</div>
          <div class="text-[#6b7280] text-xs md:text-sm">Schválených</div>
        </div>
        <div class="adsun-card p-4 md:p-6 animate-fade-in-up stagger-3">
          <div class="stats-number stats-number-orange mb-1">{stats.pending}</div>
          <div class="text-[#6b7280] text-xs md:text-sm leading-tight">Čaká na schválenie</div>
        </div>
      </div>

      <!-- Filter tabs -->
      <div class="flex gap-2 mb-6 overflow-x-auto pb-2 pr-4 scrollbar-hide">
        <button data-filter="all" class="filter-btn active">
          Všetky
        </button>
        <button data-filter="pending" class="filter-btn">
          Na schválenie
        </button>
        <button data-filter="approved" class="filter-btn">
          Schválené
        </button>
        <button data-filter="draft" class="filter-btn">
          V príprave
        </button>
      </div>

      {calculations.length === 0 ? (
        <div class="adsun-card p-12 text-center animate-fade-in-up">
          <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-[#1a1a1a] flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
            </svg>
          </div>
          <h2 class="text-xl font-semibold text-white mb-2">Zatiaľ žiadne cenové ponuky</h2>
          <p class="text-[#6b7280]">Vaše cenové ponuky sa tu zobrazia hneď ako budú vytvorené.</p>
        </div>
      ) : (
        <div class="space-y-4" id="calculationsContainer">
          {/* Projects with calculations */}
          {groupedProjects.map((group, projectIndex) => {
            const projectApproved = group.calculations.filter(c => c.approvalStatus === 'CLIENT_APPROVED').length;
            const projectTotal = group.calculations.length;
            const allApproved = projectApproved === projectTotal;
            
            return (
              <details 
                class={`project-group adsun-card overflow-hidden animate-fade-in-up ${allApproved ? 'adsun-card-active' : ''}`}
                style={`animation-delay: ${projectIndex * 50}ms`}
                open
              >
                <summary class="flex items-center justify-between p-4 md:p-5 cursor-pointer hover:bg-[#1a1a1a] transition-colors gap-3">
                  <div class="flex items-center gap-3 md:gap-4 flex-1 min-w-0">
                    <div class="w-9 h-9 md:w-10 md:h-10 rounded-lg bg-[#f59e0b]/10 flex items-center justify-center flex-shrink-0">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                      </svg>
                    </div>
                    <div class="min-w-0 flex-1">
                      <h3 class="text-base md:text-lg font-semibold text-white truncate">{group.project.name}</h3>
                      <div class="flex flex-wrap items-center gap-2 md:gap-3 text-xs md:text-sm text-[#9ca3af]">
                        <span>{projectTotal} {projectTotal === 1 ? 'ponuka' : projectTotal < 5 ? 'ponuky' : 'ponúk'}</span>
                        {projectApproved > 0 && (
                          <span class="flex items-center gap-1 text-[#4ade80]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            {projectApproved} schválených
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                  <div class="flex items-center gap-2 md:gap-4 flex-shrink-0">
                    <div class="text-right">
                      <div class="text-base md:text-lg font-bold text-[#f59e0b] whitespace-nowrap">
                        {group.project.totalPrice?.toLocaleString('sk-SK', { minimumFractionDigits: 0 }) || '0'} €
                      </div>
                    </div>
                    <svg class="w-4 h-4 md:w-5 md:h-5 text-[#6b7280] transition-transform project-chevron flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="6 9 12 15 18 9"/>
                    </svg>
                  </div>
                </summary>
                
                <div class="border-t border-[#2a2a2a] bg-[#0f0f0f]">
                  <div class="p-4 space-y-3">
                    {group.calculations.map((calc) => {
                      const status = statusConfig[calc.approvalStatus] || statusConfig['DRAFT'];
                      const isApproved = calc.approvalStatus === 'CLIENT_APPROVED';
                      const quoteUrl = calc.orderId ? `/order/${calc.orderId}/quote?from=quotes` : null;
                      
                      return (
                      <a 
                        href={quoteUrl || '#'}
                        class={`calculation-card block rounded-lg p-3 md:p-4 transition-all ${quoteUrl ? 'cursor-pointer' : 'pointer-events-none opacity-60'} ${isApproved ? 'bg-[#22c55e]/10 hover:bg-[#22c55e]/20 border border-[#22c55e]/30' : 'bg-[#1a1a1a] hover:bg-[#2a2a2a]'}`}
                        data-status={calc.approvalStatus}
                      >
                        <div class="flex items-center justify-between gap-3">
                          <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                              <span class={`px-2 py-0.5 md:px-2.5 md:py-1 rounded-md text-xs font-medium ${status.cssClass}`}>
                                {status.label}
                              </span>
                            </div>
                            <h4 class={`text-sm md:text-base font-medium truncate ${isApproved ? 'text-[#4ade80]' : 'text-white'}`}>{calc.name}</h4>
                            <div class="text-xs text-[#6b7280] mt-1 flex items-center gap-1">
                              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                              </svg>
                              {formatDate(calc.updatedAt)}
                            </div>
                          </div>
                          
                          <div class="flex items-center gap-2 flex-shrink-0">
                            {calc.totalPrice && calc.totalPrice > 0 && (
                              <div class={`text-base md:text-lg font-bold whitespace-nowrap ${isApproved ? 'text-[#4ade80]' : 'text-[#f59e0b]'}`}>
                                {calc.totalPrice.toLocaleString('sk-SK', { minimumFractionDigits: 0 })} €
                              </div>
                            )}
                          </div>
                        </div>
                      </a>
                      );
                    })}
                  </div>
                </div>
              </details>
            );
          })}

          {/* Unassigned calculations */}
          {unassignedCalcs.length > 0 && (
            <details 
              class="project-group adsun-card overflow-hidden animate-fade-in-up"
              open
            >
              <summary class="flex items-center justify-between p-5 cursor-pointer hover:bg-[#1a1a1a] transition-colors">
                <div class="flex items-center gap-4">
                  <div class="w-10 h-10 rounded-lg bg-[#6b7280]/10 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14 2 14 8 20 8"/>
                    </svg>
                  </div>
                  <div>
                    <h3 class="text-lg font-semibold text-white">Nezaradené ponuky</h3>
                    <div class="text-sm text-[#9ca3af]">{unassignedCalcs.length} ponúk bez projektu</div>
                  </div>
                </div>
                <svg class="w-5 h-5 text-[#6b7280] transition-transform project-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="6 9 12 15 18 9"/>
                </svg>
              </summary>
              
              <div class="border-t border-[#2a2a2a] bg-[#0f0f0f]">
                <div class="p-4 space-y-3">
                  {unassignedCalcs.map((calc) => {
                    const status = statusConfig[calc.approvalStatus] || statusConfig['DRAFT'];
                    const isApproved = calc.approvalStatus === 'CLIENT_APPROVED';
                    const quoteUrl = calc.orderId ? `/order/${calc.orderId}/quote?from=quotes` : null;
                    
                    return (
                      <a 
                        href={quoteUrl || '#'}
                        class={`calculation-card block rounded-lg p-4 transition-all ${quoteUrl ? 'cursor-pointer' : 'pointer-events-none opacity-60'} ${isApproved ? 'bg-[#22c55e]/10 hover:bg-[#22c55e]/20 border border-[#22c55e]/30' : 'bg-[#1a1a1a] hover:bg-[#2a2a2a]'}`}
                        data-status={calc.approvalStatus}
                      >
                        <div class="flex items-center justify-between gap-4">
                          <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                              <span class={`px-2.5 py-1 rounded-md text-xs font-medium ${status.cssClass}`}>
                                {status.label}
                              </span>
                            </div>
                            <h4 class={`font-medium truncate ${isApproved ? 'text-[#4ade80]' : 'text-white'}`}>{calc.name}</h4>
                            <div class="text-xs text-[#6b7280] mt-1">{formatDate(calc.updatedAt)}</div>
                          </div>
                          
                          <div class="flex items-center gap-3 flex-shrink-0">
                            {calc.totalPrice && calc.totalPrice > 0 && (
                              <div class={`text-lg font-bold ${isApproved ? 'text-[#4ade80]' : 'text-[#f59e0b]'}`}>
                                {calc.totalPrice.toLocaleString('sk-SK', { minimumFractionDigits: 0 })} €
                              </div>
                            )}
                            {quoteUrl && (
                              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"/>
                              </svg>
                            )}
                          </div>
                        </div>
                      </a>
                    );
                  })}
                </div>
              </div>
            </details>
          )}
        </div>
      )}
    </div>
  </main>
</Layout>

<style>
  .filter-btn {
    background: rgba(26, 26, 26, 0.8);
    color: #9ca3af;
    border: 1px solid transparent;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s;
    white-space: nowrap;
  }
  
  .filter-btn:hover {
    background: rgba(42, 42, 42, 0.8);
    color: #ffffff;
    border-color: rgba(245, 158, 11, 0.3);
  }
  
  .filter-btn.active {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
    border-color: rgba(245, 158, 11, 0.5);
  }
  
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  
  /* Project accordion */
  .project-group summary {
    list-style: none;
  }
  
  .project-group summary::-webkit-details-marker {
    display: none;
  }
  
  .project-group[open] .project-chevron {
    transform: rotate(180deg);
  }
  
  .project-group summary:focus {
    outline: none;
  }
</style>

<script>
  // Filter functionality
  const filterBtns = document.querySelectorAll('.filter-btn');
  
  function updateFilters() {
    const calcCards = document.querySelectorAll('.calculation-card');
    const activeBtn = document.querySelector('.filter-btn.active');
    const filter = activeBtn?.getAttribute('data-filter') || 'all';
    
    calcCards.forEach(card => {
      const status = card.getAttribute('data-status');
      let show = true;
      if (filter === 'pending') show = status === 'CLIENT_VIEWED';
      if (filter === 'approved') show = status === 'CLIENT_APPROVED';
      if (filter === 'draft') show = status === 'DRAFT';
      (card as HTMLElement).style.display = show ? 'block' : 'none';
    });
  }
  
  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      filterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      updateFilters();
    });
  });
</script>
