---
import Layout from '../../layouts/Layout.astro';
import DashboardHeader from '../../components/DashboardHeader.astro';
import { getSessionFromCookie } from '../../lib/session';
import { getCalculationById, getCalculationProducts, getCalculationActivities } from '../../lib/db';
import { format } from 'date-fns';
import { sk } from 'date-fns/locale';

// Check authentication
const session = getSessionFromCookie(Astro.request.headers.get('cookie'));

if (!session) {
  return Astro.redirect('/');
}

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/quotes');
}

// Get calculation
const calculation = await getCalculationById(id);

if (!calculation) {
  return Astro.redirect('/quotes');
}

// Access is already verified by getClientCalculations in quotes.astro
// If the calculation exists, the authenticated user should have access

// Get products from calculation
const products = await getCalculationProducts(id);

// Get communication history
const activities = await getCalculationActivities(id);
const communicationActivities = activities.filter(a => 
  a.action === 'question_received' || 
  a.action === 'client_requested_changes' ||
  a.action === 'client_approved' ||
  a.action === 'client_rejected'
);

// Status config
const statusConfig: Record<string, { label: string; color: string; bgColor: string; icon: string }> = {
  'DRAFT': { label: 'V pr√≠prave', color: 'text-slate-400', bgColor: 'bg-slate-500/20', icon: 'üìù' },
  'CLIENT_VIEWED': { label: 'ƒåak√° na schv√°lenie', color: 'text-amber-400', bgColor: 'bg-amber-500/20', icon: '‚è≥' },
  'CLIENT_APPROVED': { label: 'Schv√°len√©', color: 'text-emerald-400', bgColor: 'bg-emerald-500/20', icon: '‚úÖ' },
  'CLIENT_REJECTED': { label: 'Zamietnut√©', color: 'text-red-400', bgColor: 'bg-red-500/20', icon: '‚ùå' },
  'CLIENT_REQUESTED_CHANGES': { label: 'Po≈æadovan√© zmeny', color: 'text-orange-400', bgColor: 'bg-orange-500/20', icon: '‚úèÔ∏è' },
  'WAITING_FOR_CLIENT': { label: 'ƒåak√° na V√°s', color: 'text-amber-400', bgColor: 'bg-amber-500/20', icon: '‚è≥' },
};

const approvalStatus = calculation.approvalStatus || 'DRAFT';
const currentStatus = statusConfig[approvalStatus] || statusConfig['DRAFT'];
const isApproved = approvalStatus === 'CLIENT_APPROVED';
const clientRequestMessage = calculation.calculationData?.clientRequestMessage || null;
const isWaitingForClient = approvalStatus === 'WAITING_FOR_CLIENT';

// Calculate totals
const vatRate = 20;
const subtotal = Math.round(products.reduce((sum, p) => sum + (p.totalPrice || 0), 0) * 100) / 100;
const vatAmount = Math.round(subtotal * (vatRate / 100) * 100) / 100;
const totalWithVat = Math.round((subtotal + vatAmount) * 100) / 100;

// Use calculation total if available
const displayTotal = calculation.totalPrice || subtotal;
const displayVat = Math.round(displayTotal * (vatRate / 100) * 100) / 100;
const displayTotalWithVat = Math.round((displayTotal + displayVat) * 100) / 100;

function formatDate(date: Date | number | null): string {
  if (!date) return '‚Äî';
  try {
    const d = typeof date === 'number' ? new Date(date) : new Date(date);
    return format(d, 'd. MMMM yyyy', { locale: sk });
  } catch {
    return '‚Äî';
  }
}
---

<Layout title={`Cenov√° ponuka - ${calculation.name}`}>
  <main class="min-h-screen">
    <DashboardHeader customerName={session.customerName} />
    
    <div class="max-w-3xl mx-auto px-3 sm:px-4 py-4 sm:py-8">
      <!-- Back button -->
      <a href="/quotes" class="inline-flex items-center gap-1.5 sm:gap-2 text-slate-400 hover:text-white transition-colors mb-4 sm:mb-6 text-sm sm:text-base">
        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Sp√§≈• na cenov√© ponuky
      </a>

      <!-- Quote header -->
      <div class:list={[
        "rounded-2xl sm:rounded-3xl p-4 sm:p-8 mb-4 sm:mb-6 animate-fade-in-up",
        isApproved ? "bg-emerald-500/10 border-2 border-emerald-500/30" : "glass"
      ]}>
        <div class="text-center mb-6 sm:mb-8">
          <div class="flex flex-wrap items-center justify-center gap-1.5 sm:gap-2 mb-3 sm:mb-4">
            <div class="inline-flex items-center gap-1.5 sm:gap-2 px-2.5 sm:px-4 py-1.5 sm:py-2 bg-blue-500/20 rounded-full text-blue-400 text-xs sm:text-sm font-medium">
              <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              Cenov√° ponuka
            </div>
            <div class={`inline-flex items-center gap-1.5 sm:gap-2 px-2.5 sm:px-4 py-1.5 sm:py-2 rounded-full text-xs sm:text-sm font-medium ${currentStatus.bgColor} ${currentStatus.color}`}>
              <span>{currentStatus.icon}</span>
              {currentStatus.label}
            </div>
          </div>
          <h1 class="text-lg sm:text-2xl md:text-3xl font-bold text-white mb-1 sm:mb-2 px-2 break-words hyphens-auto leading-tight">{calculation.name}</h1>
          {calculation.calculationNumber && (
            <p class="text-slate-400 text-sm sm:text-base">ƒå√≠slo: {calculation.calculationNumber}</p>
          )}
          
          {isApproved && (
            <div class="mt-3 sm:mt-4 inline-flex items-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-1.5 sm:py-2 bg-emerald-500/20 rounded-full text-emerald-400 text-xs sm:text-sm">
              <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
              </svg>
              <span class="hidden sm:inline">T√°to ponuka bola schv√°len√°.</span>
              <span class="sm:hidden">Schv√°len√©</span>
            </div>
          )}

          {/* Waiting for Client - Request Message */}
          {isWaitingForClient && clientRequestMessage && (
            <div class="mt-4 p-4 bg-amber-500/10 border border-amber-500/30 rounded-xl text-left">
              <div class="flex items-start gap-3">
                <div class="w-10 h-10 bg-amber-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                  <svg class="w-5 h-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                </div>
                <div class="flex-1">
                  <h4 class="text-amber-400 font-semibold text-sm mb-1">Potrebujeme od V√°s</h4>
                  <p class="text-slate-400 text-xs mb-2">Pros√≠m dodajte nasledovn√© √∫daje:</p>
                  <div class="bg-slate-800/50 rounded-lg p-3 text-white whitespace-pre-wrap text-sm">
                    {clientRequestMessage}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
        
        <!-- Price Summary -->
        <div class="glass-light rounded-xl p-4 sm:p-6 mb-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-white font-semibold">Cenov√Ω s√∫hrn</h3>
          </div>
          
          <div class="space-y-2 text-sm">
            <div class="flex justify-between text-slate-400">
              <span>Medzis√∫ƒçet bez DPH</span>
              <span class="text-white">{displayTotal.toLocaleString('sk-SK', { minimumFractionDigits: 2 })} ‚Ç¨</span>
            </div>
            <div class="flex justify-between text-slate-400">
              <span>DPH {vatRate}%</span>
              <span class="text-white">{displayVat.toLocaleString('sk-SK', { minimumFractionDigits: 2 })} ‚Ç¨</span>
            </div>
            <div class="border-t border-slate-700 pt-2 mt-2">
              <div class="flex justify-between">
                <span class="text-white font-semibold">Celkom s DPH</span>
                <span class="text-[#f59e0b] font-bold text-lg">{displayTotalWithVat.toLocaleString('sk-SK', { minimumFractionDigits: 2 })} ‚Ç¨</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Products -->
        {products.length > 0 && (
          <div class="glass-light rounded-xl p-4 sm:p-6">
            <h3 class="text-white font-semibold mb-4">Produkty ({products.length})</h3>
            <div class="space-y-3">
              {products.map((product) => (
                <div class="flex justify-between items-start p-3 bg-slate-800/50 rounded-lg">
                  <div class="flex-1 min-w-0">
                    <p class="text-white font-medium truncate">{product.name}</p>
                    {product.dimensions && (
                      <p class="text-slate-400 text-xs mt-1">{product.dimensions}</p>
                    )}
                    <p class="text-slate-500 text-xs mt-1">{product.quantity}√ó ks</p>
                  </div>
                  <div class="text-right ml-4">
                    <p class="text-[#f59e0b] font-semibold">{(product.totalPrice || 0).toLocaleString('sk-SK', { minimumFractionDigits: 2 })} ‚Ç¨</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {products.length === 0 && (
          <div class="glass-light rounded-xl p-6 text-center">
            <p class="text-slate-400">Detaily produktov nie s√∫ k dispoz√≠cii.</p>
          </div>
        )}
      </div>

      <!-- Communication History -->
      {communicationActivities.length > 0 && (
        <div class="glass rounded-2xl p-4 sm:p-6 mb-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center">
              <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-white">Hist√≥ria komunik√°cie</h3>
          </div>
          <div class="space-y-3">
            {communicationActivities.map((activity) => {
              const isQuestion = activity.action === 'question_received' || activity.action === 'client_requested_changes';
              const isApproval = activity.action === 'client_approved';
              
              return (
                <div class={`rounded-xl p-4 ${isQuestion ? 'bg-amber-500/10 border border-amber-500/20' : isApproval ? 'bg-emerald-500/10 border border-emerald-500/20' : 'bg-red-500/10 border border-red-500/20'}`}>
                  <div class="flex items-start gap-3">
                    <div class={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${isQuestion ? 'bg-amber-500/20' : isApproval ? 'bg-emerald-500/20' : 'bg-red-500/20'}`}>
                      {isQuestion ? (
                        <svg class="w-4 h-4 text-amber-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
                        </svg>
                      ) : isApproval ? (
                        <svg class="w-4 h-4 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                      ) : (
                        <svg class="w-4 h-4 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                      )}
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class={`text-sm font-medium ${isQuestion ? 'text-amber-300' : isApproval ? 'text-emerald-300' : 'text-red-300'}`}>
                        {isQuestion ? 'Va≈°a ot√°zka' : isApproval ? 'Schv√°len√©' : 'Zamietnut√©'}
                      </div>
                      {activity.comment && (
                        <p class="text-slate-300 text-sm mt-1 whitespace-pre-wrap">"{activity.comment}"</p>
                      )}
                      <p class="text-slate-500 text-xs mt-2">
                        {format(activity.createdAt, 'd. MMM yyyy, HH:mm', { locale: sk })}
                      </p>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}
    </div>
  </main>
</Layout>
